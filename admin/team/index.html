<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silver Key Realty â€” Team Management</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/tokens.css"><link rel="stylesheet" href="../../assets/css/base.css"><link rel="stylesheet" href="../../assets/css/admin.css">
  <style>
    .stat-card { text-align:center; position:relative; overflow:hidden; }
    .stat-card::before {
      content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%;
      background:radial-gradient(ellipse at center, var(--glow) 0%, transparent 70%);
      opacity:0.08; pointer-events:none;
    }
    .stat-card:hover::before { opacity:0.14; }
    .stat-card .stat-num { font-family:'Cormorant Garamond',serif; font-size:36px; margin-top:8px; transition:transform .2s; }
    .stat-card:hover .stat-num { transform:scale(1.05); }
    .stat-label { font-size:10px; color:#9A8E80; text-transform:uppercase; letter-spacing:1.5px; font-weight:400; }

    .member-row { display:grid; grid-template-columns:2fr 1fr 80px 1fr 100px; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.03); transition:background .15s; }
    .member-row:hover { background:rgba(58,148,100,.03); }
    .member-name { font-weight:400; color:#F0EBE3; font-size:14px; }
    .member-email { font-size:11px; color:#7A6E60; margin-top:2px; }
    .member-role { font-size:12px; color:#C9B99A; }
    .member-status { font-size:11px; }
    .member-title { font-size:12px; color:#9A8E80; }
    .status-active { color:#3A9464; } .status-inactive { color:#e74c3c; }

    .add-modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; }
    .add-modal.open { display:flex; }
    .add-form { background:#1A1A1A; border:1px solid rgba(255,255,255,.04); padding:32px; width:100%; max-width:480px; }
    .add-form h2 { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:300; color:#F0EBE3; margin-bottom:24px; }
    .add-form h2 em { color:#C9B99A; }
    .form-row { margin-bottom:16px; }
    .form-row label { display:block; font-size:10px; color:#9A8E80; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:6px; }
    .form-row input, .form-row select { width:100%; padding:10px 14px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); color:#F0EBE3; font-family:'Outfit',sans-serif; font-size:13px; outline:none; }
    .form-row input:focus, .form-row select:focus { border-color:rgba(58,148,100,.4); }
    .form-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:24px; }
    .btn-cancel { padding:10px 20px; background:none; border:1px solid rgba(255,255,255,.08); color:#9A8E80; font-family:'Outfit',sans-serif; font-size:11px; letter-spacing:1.5px; text-transform:uppercase; cursor:pointer; }
    .btn-save { padding:10px 20px; background:#3A9464; border:none; color:#F0EBE3; font-family:'Outfit',sans-serif; font-size:11px; letter-spacing:1.5px; text-transform:uppercase; cursor:pointer; }
    .btn-save:disabled { opacity:.5; }

    @media(max-width:900px) {
      .member-row { grid-template-columns:1fr 1fr; gap:8px; }
    }
  </style>
</head>
<body>
  <div id="skr-loader" class="skr-loader"><div class="skr-spinner"></div></div>
  <div id="skr-main" class="skr-shell" style="display:none">
    <aside id="skr-sidebar" class="skr-sidebar"></aside>
    <main class="skr-content">
      <div class="skr-page-header" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h1 class="skr-page-title">Team <em>Management</em></h1>
          <p class="skr-page-sub">Add, edit, and manage your team members</p>
        </div>
        <button class="skr-btn skr-btn-primary" onclick="document.getElementById('add-modal').classList.add('open')">+ Add Employee</button>
      </div>

      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px">
        <div class="skr-card stat-card" style="--glow:#a78bfa"><div class="stat-label">Total Members</div><div class="stat-num" id="stat-total" style="color:#a78bfa">&mdash;</div></div>
        <div class="skr-card stat-card" style="--glow:#E8854A"><div class="stat-label">Active</div><div class="stat-num" id="stat-active" style="color:#E8854A">&mdash;</div></div>
        <div class="skr-card stat-card" style="--glow:#e74c3c"><div class="stat-label">Inactive</div><div class="stat-num" id="stat-inactive" style="color:#e74c3c">&mdash;</div></div>
        <div class="skr-card stat-card" style="--glow:#3b82f6"><div class="stat-label">Pending Invites</div><div class="stat-num" id="stat-pending" style="color:#3b82f6">&mdash;</div></div>
      </div>

      <div class="skr-card" style="padding:0;overflow-x:auto">
        <div class="member-row" style="border-bottom:1px solid rgba(255,255,255,.06);padding:10px 16px">
          <div style="font-size:10px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Name</div>
          <div style="font-size:10px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Role</div>
          <div style="font-size:10px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Status</div>
          <div style="font-size:10px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Title</div>
          <div style="font-size:10px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Actions</div>
        </div>
        <div id="team-list"><div style="padding:40px;text-align:center;color:#7A6E60;font-size:13px">Loading team members...</div></div>
      </div>
    </main>
  </div>

  <div id="add-modal" class="add-modal">
    <div class="add-form">
      <h2>Add <em>Employee</em></h2>
      <div class="form-row"><label>First Name</label><input id="af-first" placeholder="Dana"></div>
      <div class="form-row"><label>Last Name</label><input id="af-last" placeholder="Williams"></div>
      <div class="form-row"><label>Email</label><input id="af-email" type="email" placeholder="dana@silverkeyrealty.llc"></div>
      <div class="form-row"><label>Title</label><input id="af-title" placeholder="Managing Broker"></div>
      <div class="form-row"><label>Role</label>
        <select id="af-role">
          <option value="">&#8212; Select Role &#8212;</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn-cancel" onclick="document.getElementById('add-modal').classList.remove('open')">Cancel</button>
        <button class="btn-save" id="af-btn" onclick="addEmployee()">Add Employee</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../assets/js/admin-config.js"></script>
  <script src="../../assets/js/skr-auth.js"></script>
  <script>
    window.addEventListener('skr-ready', async function() {
      await loadRoles();
      await loadTeam();
    });

    var roles = [];

    async function loadRoles() {
      var sb = window.SKR_SUPA;
      var result = await sb.from('skr_roles').select('id, role_name, permission_level').order('permission_level', { ascending: false });
      roles = result.data || [];
      var sel = document.getElementById('af-role');
      sel.innerHTML = '<option value="">&#8212; Select Role &#8212;</option>' + roles.map(function(r) {
        return '<option value="' + r.id + '">' + r.role_name + ' (Level ' + r.permission_level + ')</option>';
      }).join('');
    }

    async function loadTeam() {
      var sb = window.SKR_SUPA;
      var u = window.SKR_USER;

      var result = await sb
        .from('skr_team_members')
        .select('id, first_name, last_name, email, title, is_active, role_id, skr_roles!inner(role_name, permission_level)')
        .eq('tenant_id', u.tenantId)
        .order('last_name');

      if (result.error) {
        document.getElementById('team-list').innerHTML = '<div style="padding:20px;color:#e74c3c;font-size:13px">Error loading team: ' + result.error.message + '</div>';
        return;
      }

      var members = result.data || [];
      var total = members.length;
      var active = members.filter(function(m) { return m.is_active; }).length;
      var inactive = total - active;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-active').textContent = active;
      document.getElementById('stat-inactive').textContent = inactive;

      try {
        var invResult = await sb.from('skr_invitations').select('id', { count: 'exact', head: true }).eq('tenant_id', u.tenantId).eq('status', 'pending');
        document.getElementById('stat-pending').textContent = invResult.count || 0;
      } catch (e) {
        document.getElementById('stat-pending').textContent = '0';
      }

      if (members.length === 0) {
        document.getElementById('team-list').innerHTML = '<div style="padding:40px;text-align:center;color:#7A6E60;font-size:13px">No team members found. Add your first employee.</div>';
        return;
      }

      document.getElementById('team-list').innerHTML = members.map(function(m) {
        var roleName = m.skr_roles ? m.skr_roles.role_name : 'Unknown';
        var fullName = (m.first_name || '') + ' ' + (m.last_name || '');
        return '<div class="member-row">'
          + '<div><div class="member-name">' + fullName + '</div><div class="member-email">' + (m.email || '') + '</div></div>'
          + '<div class="member-role">' + roleName + '</div>'
          + '<div class="member-status ' + (m.is_active ? 'status-active' : 'status-inactive') + '">' + (m.is_active ? '&#9679; Active' : '&#9675; Inactive') + '</div>'
          + '<div class="member-title">' + (m.title || '&#8212;') + '</div>'
          + '<div><button onclick="toggleActive(\'' + m.id + '\',' + (!m.is_active) + ')" style="padding:4px 10px;font-size:10px;letter-spacing:1px;text-transform:uppercase;border:1px solid rgba(255,255,255,.08);background:none;color:#9A8E80;cursor:pointer;font-family:\'Outfit\',sans-serif">'
          + (m.is_active ? 'Deactivate' : 'Activate') + '</button></div>'
          + '</div>';
      }).join('');
    }

    async function addEmployee() {
      var first = document.getElementById('af-first').value.trim();
      var last = document.getElementById('af-last').value.trim();
      var email = document.getElementById('af-email').value.trim();
      var title = document.getElementById('af-title').value.trim();
      var roleId = document.getElementById('af-role').value;

      if (!first || !email || !roleId) { alert('First name, email, and role are required.'); return; }

      var btn = document.getElementById('af-btn');
      btn.textContent = 'Adding...'; btn.disabled = true;

      var sb = window.SKR_SUPA;
      var u = window.SKR_USER;

      var result = await sb.from('skr_team_members').insert({
        tenant_id: u.tenantId,
        first_name: first,
        last_name: last,
        email: email,
        title: title || null,
        role_id: roleId,
        is_active: true,
      });

      if (result.error) {
        alert('Error: ' + result.error.message);
        btn.textContent = 'Add Employee'; btn.disabled = false;
        return;
      }

      document.getElementById('add-modal').classList.remove('open');
      btn.textContent = 'Add Employee'; btn.disabled = false;
      document.getElementById('af-first').value = '';
      document.getElementById('af-last').value = '';
      document.getElementById('af-email').value = '';
      document.getElementById('af-title').value = '';
      document.getElementById('af-role').value = '';
      await loadTeam();
    }

    async function toggleActive(id, newState) {
      var sb = window.SKR_SUPA;
      await sb.from('skr_team_members').update({ is_active: newState }).eq('id', id);
      await loadTeam();
    }
  </script>
</body>
</html>
