<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email — Silver Key Realty</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/tokens.css?v=2">
  <link rel="stylesheet" href="../../assets/css/base.css?v=2">
  <link rel="stylesheet" href="../../assets/css/nav.css?v=2">
  <link rel="stylesheet" href="../../assets/css/responsive.css?v=2">
  <link rel="stylesheet" href="../../assets/css/admin.css?v=2">
  <style>
    :root{--bg:#111;--card-bg:rgba(255,255,255,0.015);--card-border:rgba(255,255,255,0.04);--row-hover:rgba(58,148,100,0.04);--serif:'Cormorant Garamond',Georgia,serif;--sans:'Outfit',Arial,sans-serif;--cream:#F0EBE3;--champagne:#C9B99A;--silver:#8A8178;--skr-green:#3A9464;--skr-green-light:#3A9464}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);font-family:var(--sans);color:var(--cream);min-height:100vh;-webkit-font-smoothing:antialiased}

    .admin-layout{display:flex;min-height:100vh}
    .sidebar{width:220px;background:#0D0D0D;position:fixed;top:0;left:0;bottom:0;padding:80px 0 24px;z-index:100;border-right:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column}
    .sidebar-nav{flex:1;padding:16px 0}
    .sidebar-item{display:flex;align-items:center;gap:12px;padding:12px 24px;font-family:var(--sans);font-size:13px;font-weight:300;color:#8A8178;text-decoration:none;transition:all 0.2s;border-left:2px solid transparent}
    .sidebar-item:hover{color:var(--cream);background:rgba(255,255,255,0.02)}
    .sidebar-item.active{color:var(--cream);border-left-color:#3A9464;background:rgba(58,148,100,0.04)}
    .sidebar-icon{font-size:14px;width:20px;text-align:center}
    .sidebar-user{padding:16px 24px;border-top:1px solid rgba(255,255,255,0.04)}
    .sidebar-user-name{font-family:var(--sans);font-size:13px;font-weight:400;color:var(--cream)}
    .sidebar-user-role{font-family:var(--sans);font-size:9px;font-weight:400;letter-spacing:2px;text-transform:uppercase;color:#3A9464;margin-top:2px}
    .main-content{margin-left:220px;flex:1;padding:32px;padding-top:96px}

    .loading-state{min-height:100vh;display:flex;align-items:center;justify-content:center}
    .spinner{width:24px;height:24px;border:2px solid rgba(58,148,100,.2);border-top-color:var(--skr-green);border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .breadcrumb{font-family:var(--sans);font-size:10px;font-weight:400;letter-spacing:2.5px;text-transform:uppercase;color:#A89888;margin-bottom:8px}
    .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;padding-bottom:24px;border-bottom:1px solid rgba(255,255,255,0.04)}
    .page-title{font-family:var(--serif);font-size:26px;font-weight:300;color:var(--cream);line-height:1.2;margin-top:4px}
    .page-title em{color:var(--champagne);font-style:italic}
    .page-sub{font-family:var(--sans);font-size:12px;font-weight:300;color:var(--silver);margin-top:4px}
    .btn-new{font-family:var(--sans);font-size:10px;font-weight:400;letter-spacing:2px;text-transform:uppercase;color:var(--bg);background:var(--cream);padding:10px 22px;border:none;cursor:pointer;transition:all .4s;white-space:nowrap}
    .btn-new:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}

    .section-card{background:var(--card-bg);border:1px solid var(--card-border);padding:24px;margin-bottom:20px}
    .section-title{font-family:var(--serif);font-size:18px;font-weight:400;color:var(--cream);margin-bottom:16px}

    .email-table{width:100%;border-collapse:collapse}
    .email-table thead th{font-family:var(--sans);font-size:10px;font-weight:400;letter-spacing:2px;text-transform:uppercase;color:var(--champagne);padding:14px 16px;text-align:left;border-bottom:1px solid rgba(255,255,255,.06)}
    .email-table tbody tr{border-bottom:1px solid rgba(255,255,255,.02);transition:background .2s}
    .email-table tbody tr:hover{background:var(--row-hover)}
    .email-table td{font-family:var(--sans);font-size:13px;font-weight:300;color:var(--cream);padding:14px 16px}

    .badge{font-family:var(--sans);font-size:9px;font-weight:400;letter-spacing:1.5px;text-transform:uppercase;padding:3px 10px;display:inline-block;white-space:nowrap}
    .badge-green{background:rgba(58,148,100,.12);color:var(--skr-green);border:1px solid rgba(58,148,100,.25)}
    .badge-silver{background:rgba(255,255,255,.04);color:var(--silver);border:1px solid rgba(255,255,255,.08)}

    .mailbox-item{padding:12px 0;border-bottom:1px solid rgba(255,255,255,.03);display:flex;justify-content:space-between;align-items:center}
    .mailbox-addr{color:var(--champagne);font-size:13px}
    .mailbox-name{color:var(--silver);font-size:12px;margin-left:12px}

    .empty-msg{text-align:center;padding:40px 20px;color:var(--silver);font-size:14px;font-weight:300}

    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center;padding:24px}
    .modal-overlay.active{display:flex}
    .modal{width:100%;max-width:600px;background:#1A1A1A;border:1px solid rgba(255,255,255,.06);padding:40px;position:relative}
    .modal::after{content:'';position:absolute;bottom:0;left:15%;width:70%;height:1px;background:var(--skr-green);filter:blur(4px);opacity:.3}
    .modal-title{font-family:var(--serif);font-size:22px;font-weight:400;color:var(--cream);margin-bottom:20px}
    .form-group{margin-bottom:18px}
    .form-label{display:block;font-family:var(--sans);font-size:10px;font-weight:300;letter-spacing:2px;text-transform:uppercase;color:var(--silver);margin-bottom:8px}
    .form-input,.form-textarea{width:100%;font-family:var(--sans);font-weight:300;font-size:14px;color:var(--cream);background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:12px 16px;outline:none;transition:border-color .3s}
    .form-input:focus,.form-textarea:focus{border-color:rgba(58,148,100,.3)}
    .form-input::placeholder,.form-textarea::placeholder{color:rgba(255,255,255,.15);font-weight:200}
    .form-textarea{min-height:180px;resize:vertical}
    .modal-actions{display:flex;gap:12px;margin-top:24px}
    .btn-primary{font-family:var(--sans);font-size:10px;font-weight:400;letter-spacing:2px;text-transform:uppercase;color:var(--bg);background:var(--cream);padding:10px 22px;border:none;cursor:pointer;transition:all .4s}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
    .btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none}
    .btn-secondary{font-family:var(--sans);font-size:10px;font-weight:300;letter-spacing:2px;text-transform:uppercase;color:var(--silver);background:transparent;border:1px solid rgba(255,255,255,.06);padding:10px 22px;cursor:pointer;transition:all .4s}
    .btn-secondary:hover{color:var(--cream);border-color:rgba(255,255,255,.12)}
    .modal-feedback{font-family:var(--sans);font-weight:300;font-size:13px;min-height:20px;margin-top:12px}
    .modal-feedback.success{color:var(--skr-green)}
    .modal-feedback.error{color:#c0392b}

    @media(max-width:900px){
      .sidebar{display:none}
      .main-content{margin-left:0;padding:20px;padding-top:80px}
      .page-header{flex-direction:column;gap:16px}
      .email-table{display:block;overflow-x:auto}
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <div id="skr-sidebar" class="sidebar"></div>

    <div class="main-content" id="mainContent" style="display:none">
      <div class="breadcrumb">Silver Key Realty</div>

      <div class="page-header">
        <div>
          <h1 class="page-title"><em>Email</em></h1>
          <p class="page-sub">Compose and send branded emails via Azure Communication Services</p>
        </div>
        <button class="btn-new" id="composeBtn">+ Compose</button>
      </div>

      <div class="section-card">
        <div class="section-title">Sent Emails</div>
        <div id="emailList"><p class="empty-msg">Loading...</p></div>
      </div>

      <div class="section-card">
        <div class="section-title">Email Mailboxes</div>
        <div id="mailboxList"><p class="empty-msg">Loading mailboxes...</p></div>
      </div>
    </div>
  </div>

  <div class="loading-state" id="loadingState"><div class="spinner"></div></div>

  <div class="modal-overlay" id="composeModal">
    <div class="modal">
      <div class="modal-title">Compose Email</div>
      <div class="form-group">
        <label class="form-label" for="emTo">To</label>
        <input class="form-input" type="email" id="emTo" placeholder="recipient@example.com">
      </div>
      <div class="form-group">
        <label class="form-label" for="emSubject">Subject</label>
        <input class="form-input" type="text" id="emSubject" placeholder="Email subject">
      </div>
      <div class="form-group">
        <label class="form-label" for="emBody">Body</label>
        <textarea class="form-textarea" id="emBody" placeholder="Write your email content..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="composeCancelBtn">Cancel</button>
        <button class="btn-primary" id="sendBtn">Send Email</button>
      </div>
      <div class="modal-feedback" id="composeFeedback"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../assets/js/admin-config.js"></script>
  <script src="../../assets/js/admin-auth.js"></script>
  <script src="../../assets/js/auth-router.js"></script>
  <script src="/admin/components/sidebar.js"></script>
  <script>
  (async function() {
    var loadingEl = document.getElementById('loadingState');
    var mainEl = document.getElementById('mainContent');

    if (!window.SKR_CONFIG || !window.SKR_CONFIG.SUPABASE_URL) {
      loadingEl.innerHTML = '<p style="color:var(--silver);font-family:var(--sans);font-size:14px">Configuration error.</p>';
      return;
    }

    var sb = window.supabase.createClient(window.SKR_CONFIG.SUPABASE_URL, window.SKR_CONFIG.SUPABASE_ANON_KEY);
    var sessionResult = await sb.auth.getSession();
    var session = sessionResult.data.session;
    if (!session) { window.location.href = '/admin/'; return; }

    var memberRaw = await sb.from('skr_team_members')
      .select('id, tenant_id, first_name, last_name, email, role_id, title, is_active, skr_roles!inner(role_name, permission_level)')
      .eq('auth_user_id', session.user.id)
      .eq('is_active', true)
      .maybeSingle();

    if (!memberRaw.data) { window.location.href = '/admin/portal/'; return; }

    var m = memberRaw.data;
    window.SKR_USER = {
      id: m.id,
      tenantId: m.tenant_id,
      role: m.skr_roles ? m.skr_roles.role_name : 'agent',
      permissionLevel: m.skr_roles ? m.skr_roles.permission_level : 0,
      displayName: ((m.first_name || '') + ' ' + (m.last_name || '')).trim()
    };

    loadingEl.style.display = 'none';
    mainEl.style.display = 'block';
    if (typeof window.initSidebar === 'function') window.initSidebar();

    var token = session.access_token;
    var tenantId = m.tenant_id;

    // Load sent emails
    var emailsResult = await sb.from('skr_email_messages_v2')
      .select('id, to_addresses, subject, status, sent_at')
      .eq('tenant_id', tenantId)
      .eq('direction', 'outbound')
      .order('sent_at', { ascending: false })
      .limit(50);

    var el = document.getElementById('emailList');
    var emails = emailsResult.data;
    if (!emails || emails.length === 0) {
      el.innerHTML = '<p class="empty-msg">No emails sent yet. Click Compose to send your first branded email.</p>';
    } else {
      el.innerHTML = '<table class="email-table"><thead><tr><th>To</th><th>Subject</th><th>Status</th><th>Sent</th></tr></thead><tbody>'
        + emails.map(function(e) {
          return '<tr>'
            + '<td style="color:var(--champagne)">' + (e.to_addresses || []).join(', ') + '</td>'
            + '<td>' + (e.subject || '') + '</td>'
            + '<td><span class="badge badge-green">' + (e.status || '') + '</span></td>'
            + '<td style="color:var(--silver);font-size:12px">' + (e.sent_at ? new Date(e.sent_at).toLocaleString() : '—') + '</td>'
            + '</tr>';
        }).join('')
        + '</tbody></table>';
    }

    // Load mailboxes
    var mbResult = await sb.from('skr_email_mailboxes')
      .select('id, email_address, display_name, status')
      .eq('tenant_id', tenantId);

    var ml = document.getElementById('mailboxList');
    var mailboxes = mbResult.data;
    if (!mailboxes || mailboxes.length === 0) {
      ml.innerHTML = '<p class="empty-msg">No mailboxes provisioned yet.</p>';
    } else {
      ml.innerHTML = mailboxes.map(function(mb) {
        return '<div class="mailbox-item">'
          + '<div><span class="mailbox-addr">' + mb.email_address + '</span><span class="mailbox-name">' + (mb.display_name || '') + '</span></div>'
          + '<span class="badge ' + (mb.status === 'active' ? 'badge-green' : 'badge-silver') + '">' + mb.status + '</span>'
          + '</div>';
      }).join('');
    }

    // Compose modal
    document.getElementById('composeBtn').addEventListener('click', function() {
      document.getElementById('composeModal').classList.add('active');
    });
    document.getElementById('composeCancelBtn').addEventListener('click', function() {
      document.getElementById('composeModal').classList.remove('active');
      document.getElementById('composeFeedback').textContent = '';
    });

    document.getElementById('sendBtn').addEventListener('click', async function() {
      var btn = this;
      var feedback = document.getElementById('composeFeedback');
      var to = document.getElementById('emTo').value.trim();
      var subject = document.getElementById('emSubject').value.trim();
      var body = document.getElementById('emBody').value.trim();

      if (!to || !subject) {
        feedback.className = 'modal-feedback error';
        feedback.textContent = 'Recipient and subject are required.';
        return;
      }

      btn.textContent = 'Sending...';
      btn.disabled = true;
      feedback.textContent = '';

      try {
        var resp = await fetch('/api/email/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ to: to, subject: subject, html_body: body })
        });
        var result = await resp.json();

        if (result.success) {
          feedback.className = 'modal-feedback success';
          feedback.textContent = 'Email sent successfully.';
          setTimeout(function() { location.reload(); }, 1200);
        } else {
          feedback.className = 'modal-feedback error';
          feedback.textContent = result.error || 'Failed to send email.';
        }
      } catch(e) {
        feedback.className = 'modal-feedback error';
        feedback.textContent = 'Send failed: ' + e.message;
      } finally {
        btn.textContent = 'Send Email';
        btn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>
