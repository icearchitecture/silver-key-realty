<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silver Key Realty — Employee Login</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body { background:#111; color:#F0EBE3; font-family:'Outfit',sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; }

    .login-card { width:100%; max-width:420px; padding:48px 40px; background:#0D0D0D; border:1px solid rgba(255,255,255,.04); }

    .login-brand { text-align:center; margin-bottom:36px; }
    .login-brand h1 { font-family:'Cormorant Garamond',serif; font-size:28px; font-weight:300; color:#F0EBE3; }
    .login-brand h1 em { color:#C9B99A; }
    .login-brand p { font-size:11px; font-weight:300; color:#7A6E60; margin-top:6px; letter-spacing:1px; text-transform:uppercase; }

    .login-form { display:flex; flex-direction:column; gap:16px; }

    .login-input { width:100%; padding:12px 16px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); color:#F0EBE3; font-family:'Outfit',sans-serif; font-size:14px; font-weight:300; outline:none; transition:border-color .3s; }
    .login-input:focus { border-color:rgba(58,148,100,.4); }
    .login-input::placeholder { color:#7A6E60; }

    .login-btn { width:100%; padding:14px; font-family:'Outfit',sans-serif; font-size:12px; font-weight:400; letter-spacing:2px; text-transform:uppercase; border:none; cursor:pointer; transition:all .3s; }
    .login-btn-primary { background:#3A9464; color:#F0EBE3; }
    .login-btn-primary:hover { background:#2d7a50; }
    .login-btn-primary:disabled { opacity:.5; cursor:not-allowed; }
    .login-btn-outline { background:none; border:1px solid rgba(255,255,255,.08); color:#9A8E80; }
    .login-btn-outline:hover { color:#F0EBE3; border-color:rgba(255,255,255,.15); }

    .login-divider { display:flex; align-items:center; gap:12px; margin:8px 0; }
    .login-divider span { font-size:10px; color:#7A6E60; letter-spacing:1.5px; text-transform:uppercase; white-space:nowrap; }
    .login-divider::before, .login-divider::after { content:''; flex:1; height:1px; background:rgba(255,255,255,.06); }

    .login-link { font-size:12px; color:#9A8E80; text-decoration:none; text-align:center; display:block; margin-top:8px; transition:color .3s; }
    .login-link:hover { color:#C9B99A; }

    .login-error { background:rgba(231,76,60,.08); border:1px solid rgba(231,76,60,.2); padding:10px 14px; font-size:12px; color:#e74c3c; display:none; }
    .login-success { background:rgba(58,148,100,.08); border:1px solid rgba(58,148,100,.2); padding:10px 14px; font-size:12px; color:#3A9464; display:none; }

    .login-footer { text-align:center; margin-top:32px; font-size:11px; color:#7A6E60; }
    .login-footer a { color:#C9B99A; text-decoration:none; }

    .login-loading { display:none; text-align:center; padding:40px; }
    .login-spinner { width:24px; height:24px; border:2px solid rgba(58,148,100,.2); border-top-color:#3A9464; border-radius:50%; animation:spin .6s linear infinite; display:inline-block; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .view { display:none; }
    .view.active { display:block; }
  </style>
</head>
<body>
  <div class="login-card">
    <div class="login-brand">
      <h1>Silver Key <em>Realty</em></h1>
      <p>Employee Portal</p>
    </div>

    <div id="view-loading" class="login-loading" style="display:block">
      <div class="login-spinner"></div>
      <p style="color:#7A6E60;font-size:12px;margin-top:12px">Checking session...</p>
    </div>

    <div id="view-login" class="view">
      <div id="login-error" class="login-error"></div>
      <div id="login-success" class="login-success"></div>

      <form id="login-form" class="login-form" onsubmit="handleLogin(event)">
        <input type="email" id="login-email" class="login-input" placeholder="Email address" required autocomplete="email">
        <input type="password" id="login-password" class="login-input" placeholder="Password" required autocomplete="current-password">
        <button type="submit" id="login-submit" class="login-btn login-btn-primary">Sign In</button>
      </form>

      <div class="login-divider"><span>or</span></div>

      <button onclick="handleMagicLink()" id="magic-btn" class="login-btn login-btn-outline" style="width:100%">Send Magic Link</button>

      <div class="login-divider"><span>external providers</span></div>

      <div style="display:flex;gap:8px">
        <button onclick="handleOAuth('google')" class="login-btn login-btn-outline" style="flex:1">Google</button>
        <button onclick="handleOAuth('azure')" class="login-btn login-btn-outline" style="flex:1">Microsoft</button>
      </div>

      <a href="#" onclick="showView('view-reset');return false" class="login-link">Forgot password?</a>
    </div>

    <div id="view-magic-sent" class="view">
      <div style="text-align:center">
        <div style="font-size:36px;margin-bottom:12px">&#9993;</div>
        <h2 style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;margin-bottom:8px">Check Your Email</h2>
        <p style="color:#9A8E80;font-size:13px;margin-bottom:20px">We sent a magic link to <strong id="magic-email-display" style="color:#C9B99A"></strong></p>
        <button onclick="showView('view-login')" class="login-btn login-btn-outline" style="width:100%">Back to Login</button>
      </div>
    </div>

    <div id="view-reset" class="view">
      <form class="login-form" onsubmit="handleReset(event)">
        <p style="color:#9A8E80;font-size:13px;margin-bottom:8px">Enter your email and we'll send a reset link.</p>
        <input type="email" id="reset-email" class="login-input" placeholder="Email address" required>
        <button type="submit" id="reset-btn" class="login-btn login-btn-primary">Send Reset Link</button>
        <button type="button" onclick="showView('view-login')" class="login-btn login-btn-outline">Back to Login</button>
      </form>
    </div>

    <div class="login-footer">
      <a href="/">&#8592; Back to Silver Key Realty</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../assets/js/admin-config.js"></script>
  <script>
    var sb;

    // Handle errors from callback redirects
    (function() {
      var params = new URLSearchParams(window.location.search);
      var error = params.get('error');
      if (error) {
        var messages = {
          callback_failed: 'Sign-in failed. Please try again.',
          no_user: 'Could not verify your identity. Please try again.',
          session_expired: 'Your session has expired. Please sign in again.'
        };
        var msg = messages[error] || 'An error occurred. Please try again.';

        var errDiv = document.createElement('div');
        errDiv.style.cssText = 'padding:12px 16px;margin-bottom:16px;border:1px solid rgba(231,76,60,0.2);background:rgba(231,76,60,0.05);color:#e74c3c;font-size:13px;text-align:center;font-family:Outfit,sans-serif;';
        errDiv.textContent = msg;

        var target = document.querySelector('.login-form')
          || document.querySelector('.skr-card')
          || document.querySelector('form')
          || document.querySelector('main');
        if (target) target.prepend(errDiv);

        window.history.replaceState({}, '', '/admin/');
      }
    })();

    // Brute force protection — client-side rate limiting
    var loginAttempts = {
      count: 0,
      lastAttempt: 0,
      locked: false,
      lockUntil: 0
    };

    function canAttemptLogin() {
      var now = Date.now();

      if (loginAttempts.locked) {
        if (now < loginAttempts.lockUntil) {
          var secondsLeft = Math.ceil((loginAttempts.lockUntil - now) / 1000);
          return { allowed: false, message: 'Too many failed attempts. Try again in ' + secondsLeft + ' seconds.' };
        }
        loginAttempts.locked = false;
        loginAttempts.count = 0;
      }

      if (now - loginAttempts.lastAttempt > 300000) {
        loginAttempts.count = 0;
      }

      return { allowed: true };
    }

    function recordFailedLogin() {
      loginAttempts.count++;
      loginAttempts.lastAttempt = Date.now();

      if (loginAttempts.count >= 5) {
        loginAttempts.locked = true;
        var lockSeconds = 30 * Math.pow(2, Math.floor(loginAttempts.count / 5) - 1);
        loginAttempts.lockUntil = Date.now() + (lockSeconds * 1000);
      }
    }

    (async function init() {
      var cfg = window.SKR_CONFIG;
      if (!cfg || !cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) {
        showError('Configuration error. Please contact your administrator.');
        showView('view-login');
        return;
      }

      sb = window.supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);

      var params = new URLSearchParams(window.location.search);
      if (params.get('error') === 'not_authorized') {
        showError('Your account is not authorized. Contact your broker for access.');
      }

      var sessionResult = await sb.auth.getSession();
      if (sessionResult.data.session) {
        var teamOk = await checkTeamMember(sessionResult.data.session);
        if (teamOk) {
          window.location.href = '/admin/dashboard/';
          return;
        }
        await sb.auth.signOut();
        showError('Your account is not authorized as a team member.');
      }

      showView('view-login');
    })();

    async function checkTeamMember(session) {
      var { data: member } = await sb
        .from('skr_team_members')
        .select('id')
        .eq('auth_user_id', session.user.id)
        .eq('is_active', true)
        .single();

      if (member) return true;

      if (session.user.email) {
        var { data: emailMember } = await sb
          .from('skr_team_members')
          .select('id')
          .eq('email', session.user.email)
          .eq('is_active', true)
          .single();

        if (emailMember) {
          await sb.from('skr_team_members').update({ auth_user_id: session.user.id }).eq('id', emailMember.id);
          return true;
        }
      }
      return false;
    }

    async function handleLogin(e) {
      e.preventDefault();
      var email = document.getElementById('login-email').value.trim();
      var password = document.getElementById('login-password').value;
      var btn = document.getElementById('login-submit');

      var loginCheck = canAttemptLogin();
      if (!loginCheck.allowed) {
        showError(loginCheck.message);
        return;
      }

      btn.textContent = 'Signing in...'; btn.disabled = true;
      hideMessages();

      var result = await sb.auth.signInWithPassword({ email: email, password: password });

      if (result.error) {
        recordFailedLogin();
        showError(result.error.message === 'Invalid login credentials' ? 'Invalid email or password.' : result.error.message);
        btn.textContent = 'Sign In'; btn.disabled = false;
        return;
      }

      var teamOk = await checkTeamMember(result.data.session);
      if (!teamOk) {
        await sb.auth.signOut();
        showError('Your account is not authorized as a team member. Contact your broker.');
        btn.textContent = 'Sign In'; btn.disabled = false;
        return;
      }

      window.location.href = '/admin/dashboard/';
    }

    async function handleMagicLink() {
      var email = document.getElementById('login-email').value.trim();
      if (!email) { showError('Enter your email address first.'); return; }

      var btn = document.getElementById('magic-btn');
      btn.textContent = 'Sending...'; btn.disabled = true;

      var result = await sb.auth.signInWithOtp({
        email: email,
        options: { emailRedirectTo: window.location.origin + '/admin/auth/callback/' }
      });

      if (result.error) {
        showError(result.error.message);
        btn.textContent = 'Send Magic Link'; btn.disabled = false;
        return;
      }

      document.getElementById('magic-email-display').textContent = email;
      showView('view-magic-sent');
      btn.textContent = 'Send Magic Link'; btn.disabled = false;
    }

    async function handleOAuth(provider) {
      var result = await sb.auth.signInWithOAuth({
        provider: provider,
        options: { redirectTo: window.location.origin + '/admin/auth/callback/' }
      });
      if (result.error) showError(result.error.message);
    }

    async function handleReset(e) {
      e.preventDefault();
      var email = document.getElementById('reset-email').value.trim();
      var btn = document.getElementById('reset-btn');
      btn.textContent = 'Sending...'; btn.disabled = true;

      await sb.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/admin/reset-password/'
      });

      showView('view-login');
      showSuccess('If that email is registered, you\'ll receive a reset link shortly.');
      btn.textContent = 'Send Reset Link'; btn.disabled = false;
    }

    function showView(id) {
      document.querySelectorAll('.view, .login-loading').forEach(function(el) { el.style.display = 'none'; el.classList.remove('active'); });
      var el = document.getElementById(id);
      if (el) { el.style.display = 'block'; el.classList.add('active'); }
    }

    function showError(msg) {
      var el = document.getElementById('login-error');
      if (el) { el.textContent = msg; el.style.display = 'block'; }
    }

    function showSuccess(msg) {
      var el = document.getElementById('login-success');
      if (el) { el.textContent = msg; el.style.display = 'block'; }
    }

    function hideMessages() {
      var err = document.getElementById('login-error');
      var suc = document.getElementById('login-success');
      if (err) err.style.display = 'none';
      if (suc) suc.style.display = 'none';
    }
  </script>
</body>
</html>
