<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silver Key Realty — Employee Login</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body { background:#111; color:#F0EBE3; font-family:'Outfit',sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; }

    .login-container {
      max-width:420px; width:100%; margin:0 auto; padding:48px 32px;
      background:#0D0D0D; border:1px solid rgba(255,255,255,.04); text-align:center;
    }

    .login-logo { font-family:Georgia,serif; font-size:22px; color:#F0EBE3; margin-bottom:32px; }
    .login-logo em { color:#C9B99A; }

    .login-accent { border-top:2px solid #3A9464; width:40px; margin:0 auto 24px; }

    .login-title {
      font-family:'Cormorant Garamond',serif; font-size:26px; font-weight:300;
      color:#F0EBE3; margin-bottom:6px;
    }

    .login-sub { font-size:13px; color:#7A6E60; margin-bottom:32px; }

    .login-error {
      display:none; padding:12px 16px; margin-bottom:16px;
      border:1px solid rgba(231,76,60,0.2); background:rgba(231,76,60,0.05);
      color:#e74c3c; font-size:13px; text-align:center;
    }

    .login-success {
      display:none; padding:12px 16px; margin-bottom:16px;
      border:1px solid rgba(58,148,100,0.2); background:rgba(58,148,100,0.05);
      color:#3A9464; font-size:13px; text-align:center;
    }

    .login-btn {
      display:flex; align-items:center; justify-content:center; gap:10px;
      width:100%; padding:14px 20px; border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03); color:#F0EBE3;
      font-family:'Outfit',sans-serif; font-size:14px; cursor:pointer;
      transition:all 0.15s; margin-bottom:8px;
    }
    .login-btn:hover { background:rgba(255,255,255,0.06); border-color:rgba(255,255,255,0.12); }
    .login-btn:disabled { opacity:0.5; cursor:not-allowed; }

    .login-btn-send {
      background:#3A9464; border-color:#3A9464;
      font-size:12px; font-weight:500; letter-spacing:2px; text-transform:uppercase; margin-top:8px;
    }
    .login-btn-send:hover { background:#2d7a52; border-color:#2d7a52; }

    .login-divider { display:flex; align-items:center; margin:20px 0; }
    .login-divider::before, .login-divider::after { content:''; flex:1; border-bottom:1px solid rgba(255,255,255,0.06); }
    .login-divider span { padding:0 16px; font-size:11px; color:#7A6E60; letter-spacing:2px; }

    .login-input {
      width:100%; padding:12px 16px; background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08); color:#F0EBE3;
      font-family:'Outfit',sans-serif; font-size:14px; outline:none; transition:all 0.15s;
    }
    .login-input:focus { border-color:rgba(58,148,100,0.4); box-shadow:0 0 0 3px rgba(58,148,100,0.05); }
    .login-input::placeholder { color:rgba(255,255,255,0.2); }

    .login-hint { font-size:11px; color:#7A6E60; margin-top:8px; font-style:italic; }

    .login-footer { font-size:11px; color:#7A6E60; margin-top:32px; }
    .login-contact { font-size:11px; color:#7A6E60; margin-top:8px; }
    .login-contact a { color:#C9B99A; text-decoration:none; }

    .login-loading { text-align:center; padding:40px; }
    .login-spinner {
      width:24px; height:24px; border:2px solid rgba(58,148,100,.2);
      border-top-color:#3A9464; border-radius:50%; animation:spin .6s linear infinite; display:inline-block;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .view { display:none; }
    .view.active { display:block; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-logo">Silver Key <em>Realty</em></div>
    <div class="login-accent"></div>

    <div id="view-loading" class="login-loading" style="display:block">
      <div class="login-spinner"></div>
      <p style="color:#7A6E60;font-size:12px;margin-top:12px">Checking session...</p>
    </div>

    <div id="view-login" class="view">
      <h1 class="login-title">Employee Sign In</h1>
      <p class="login-sub">Authorized team members only</p>

      <div id="login-error" class="login-error"></div>
      <div id="login-success" class="login-success"></div>

      <button class="login-btn" onclick="signInWithEntra()">
        <svg width="20" height="20" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
        Sign in with Entra ID (SSO)
      </button>

      <div class="login-divider"><span>OR</span></div>

      <div id="magic-link-section">
        <button class="login-btn" id="magic-toggle" onclick="showMagicLink()">&#9993; Sign in with Email</button>

        <div id="magic-form" style="display:none;margin-top:12px;">
          <input type="email" id="magic-email" class="login-input" placeholder="Enter your work email" autocomplete="email">
          <button class="login-btn login-btn-send" id="magic-send" onclick="sendMagicLink()">SEND MAGIC LINK</button>
          <p class="login-hint">We'll email you a secure link to sign in — no password needed.</p>
        </div>
      </div>

      <p class="login-footer">By continuing, you agree to Silver Key Realty's terms of service.</p>
      <p class="login-contact">Not an employee? <a href="/">Visit our website</a></p>
    </div>

    <div id="view-magic-sent" class="view">
      <div style="text-align:center">
        <div style="font-size:36px;margin-bottom:12px">&#9993;</div>
        <h2 style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;margin-bottom:8px">Check Your Email</h2>
        <p style="color:#9A8E80;font-size:13px;margin-bottom:20px">We sent a magic link to <strong id="magic-email-display" style="color:#C9B99A"></strong></p>
        <button onclick="showView('view-login')" class="login-btn" style="width:100%">Back to Login</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../assets/js/admin-config.js"></script>
  <script>
    var sb;

    (async function init() {
      var cfg = window.SKR_CONFIG;
      if (!cfg || !cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) {
        showLoginError('Configuration error. Please contact your administrator.');
        showView('view-login');
        return;
      }

      sb = window.supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);

      var params = new URLSearchParams(window.location.search);
      var error = params.get('error');
      if (error) {
        var messages = {
          callback_failed: 'Sign-in failed. Please try again.',
          no_user: 'Could not verify your identity. Please try again.',
          session_expired: 'Your session has expired. Please sign in again.',
          not_authorized: 'Your account is not authorized. Contact your broker for access.'
        };
        showLoginError(messages[error] || 'An error occurred. Please try again.');
        window.history.replaceState({}, '', '/admin/');
      }

      var sessionResult = await sb.auth.getSession();
      if (sessionResult.data.session) {
        var teamOk = await checkTeamMember(sessionResult.data.session);
        if (teamOk) {
          window.location.href = '/admin/dashboard/';
          return;
        }
        await sb.auth.signOut();
        showLoginError('Your account is not authorized as a team member.');
      }

      showView('view-login');
    })();

    async function checkTeamMember(session) {
      var result = await sb
        .from('skr_team_members')
        .select('id')
        .eq('auth_user_id', session.user.id)
        .eq('is_active', true)
        .single();

      if (result.data) return true;

      if (session.user.email) {
        var emailResult = await sb
          .from('skr_team_members')
          .select('id')
          .eq('email', session.user.email)
          .eq('is_active', true)
          .single();

        if (emailResult.data) {
          await sb.from('skr_team_members').update({ auth_user_id: session.user.id }).eq('id', emailResult.data.id);
          return true;
        }
      }
      return false;
    }

    function showMagicLink() {
      document.getElementById('magic-form').style.display = 'block';
      document.getElementById('magic-toggle').style.display = 'none';
      document.getElementById('magic-email').focus();
    }

    async function signInWithEntra() {
      var result = await sb.auth.signInWithOAuth({
        provider: 'azure',
        options: {
          scopes: 'email openid profile',
          redirectTo: window.location.origin + '/admin/auth/callback/',
          queryParams: {
            prompt: 'select_account'
          }
        }
      });

      if (result.error) {
        showLoginError('SSO sign-in failed. Please try again.');
      }
    }

    async function sendMagicLink() {
      var email = document.getElementById('magic-email').value.trim();
      if (!email) {
        showLoginError('Please enter your email address.');
        return;
      }

      var btn = document.getElementById('magic-send');
      btn.textContent = 'SENDING...';
      btn.disabled = true;

      var result = await sb.auth.signInWithOtp({
        email: email,
        options: {
          emailRedirectTo: window.location.origin + '/admin/auth/callback/'
        }
      });

      if (result.error) {
        showLoginError('Could not send magic link. Check your email address.');
        btn.textContent = 'SEND MAGIC LINK';
        btn.disabled = false;
        return;
      }

      document.getElementById('login-error').style.display = 'none';
      document.getElementById('magic-email-display').textContent = email;
      showView('view-magic-sent');
      btn.textContent = 'SEND MAGIC LINK';
      btn.disabled = false;
    }

    function showView(id) {
      document.querySelectorAll('.view, .login-loading').forEach(function(el) {
        el.style.display = 'none';
        el.classList.remove('active');
      });
      var el = document.getElementById(id);
      if (el) { el.style.display = 'block'; el.classList.add('active'); }
    }

    function showLoginError(msg) {
      var el = document.getElementById('login-error');
      el.textContent = msg;
      el.style.display = 'block';
      document.getElementById('login-success').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
      var emailInput = document.getElementById('magic-email');
      if (emailInput) {
        emailInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            sendMagicLink();
          }
        });
      }
    });
  </script>
</body>
</html>
