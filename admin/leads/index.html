<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leads — Silver Key Realty</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  
  <!-- CRITICAL CSS — INLINED so it ALWAYS loads -->
  <style>
/* ═══════════════════════════════════════════
   SKR CRITICAL CSS — Inlined in every page
   If this renders, the page looks right.
   ═══════════════════════════════════════════ */

/* Reset */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

/* Base */
:root{
  --skr-bg:#111111;
  --skr-surface:#1A1A1A;
  --skr-surface-2:#1E1E1E;
  --skr-border:rgba(255,255,255,0.04);
  --skr-border-hover:rgba(255,255,255,0.08);
  --skr-text:#F0EBE3;
  --skr-text-muted:#9A8E80;
  --skr-text-dim:#7A6E60;
  --skr-champagne:#C9B99A;
  --skr-green:#3A9464;
  --skr-green-hover:#2d7a52;
  --skr-red:#e74c3c;
  --skr-sidebar-w:220px;
  --skr-font-body:'Outfit',system-ui,-apple-system,sans-serif;
  --skr-font-heading:'Cormorant Garamond',Georgia,serif;
  --skr-font-logo:Georgia,serif;
}

html{height:100%}
body{
  min-height:100vh;background:var(--skr-bg);
  font-family:var(--skr-font-body);color:var(--skr-text);
  -webkit-font-smoothing:antialiased;
}

/* Loading Screen — visible by default, hidden when page is ready */
.skr-loader{
  position:fixed;inset:0;z-index:9999;
  background:var(--skr-bg);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  transition:opacity 0.3s ease;
}
.skr-loader.hidden{opacity:0;pointer-events:none}
.skr-loader-logo{font-family:var(--skr-font-logo);font-size:22px;color:var(--skr-text);margin-bottom:24px}
.skr-loader-logo em{color:var(--skr-champagne)}
.skr-loader-bar{width:120px;height:2px;background:rgba(255,255,255,0.06);overflow:hidden;border-radius:1px}
.skr-loader-fill{width:30%;height:100%;background:var(--skr-green);animation:skr-load 1.2s ease-in-out infinite}
@keyframes skr-load{0%{transform:translateX(-100%)}100%{transform:translateX(400%)}}
.skr-loader-text{font-size:11px;color:var(--skr-text-dim);margin-top:12px;letter-spacing:1px}

/* Shell Layout */
.skr-shell{display:flex;min-height:100vh}

/* Sidebar */
.skr-sidebar{
  width:var(--skr-sidebar-w);min-height:100vh;
  background:var(--skr-surface);
  border-right:1px solid var(--skr-border);
  display:flex;flex-direction:column;
  position:fixed;left:0;top:0;bottom:0;
  z-index:100;
  overflow-y:auto;
}
.skr-sidebar-logo{
  padding:24px 20px 20px;
  font-family:var(--skr-font-logo);font-size:16px;
  color:var(--skr-text);border-bottom:1px solid var(--skr-border);
}
.skr-sidebar-logo em{color:var(--skr-champagne)}

.skr-sidebar-nav{padding:12px 0;flex:1}
.skr-sidebar-link{
  display:flex;align-items:center;gap:10px;
  padding:10px 20px;font-size:13px;color:var(--skr-text-muted);
  text-decoration:none;transition:all 0.12s;
  border-left:2px solid transparent;
}
.skr-sidebar-link:hover{color:var(--skr-text);background:rgba(255,255,255,0.02)}
.skr-sidebar-link.active{
  color:var(--skr-champagne);
  border-left-color:var(--skr-green);
  background:rgba(58,148,100,0.04);
}
.skr-sidebar-link .icon{width:16px;text-align:center;font-size:12px;opacity:0.6}

.skr-sidebar-section{
  font-size:9px;color:var(--skr-text-dim);letter-spacing:2px;
  text-transform:uppercase;padding:16px 20px 6px;
}

.skr-sidebar-user{
  padding:16px 20px;border-top:1px solid var(--skr-border);
  font-size:12px;
}
.skr-sidebar-user-name{color:var(--skr-text);font-weight:400}
.skr-sidebar-user-role{color:var(--skr-text-dim);font-size:10px;letter-spacing:1px;text-transform:uppercase;margin-top:2px}
.skr-sidebar-signout{
  display:inline-block;margin-top:8px;font-size:10px;
  color:var(--skr-text-dim);cursor:pointer;background:none;
  border:none;font-family:var(--skr-font-body);letter-spacing:1px;
  text-transform:uppercase;
}
.skr-sidebar-signout:hover{color:var(--skr-red)}

/* Main Content */
.skr-main{
  flex:1;margin-left:var(--skr-sidebar-w);
  padding:32px;min-height:100vh;
}

/* Page Header */
.skr-page-header{margin-bottom:32px}
.skr-page-title{
  font-family:var(--skr-font-heading);font-size:32px;font-weight:300;
  color:var(--skr-text);
}
.skr-page-title em{color:var(--skr-champagne)}
.skr-page-sub{font-size:13px;color:var(--skr-text-muted);margin-top:4px}
.skr-page-meta{
  float:right;text-align:right;font-size:11px;color:var(--skr-text-dim);
}
.skr-page-meta .system-status{color:var(--skr-green);font-size:10px;letter-spacing:1px}

/* Cards */
.skr-card{
  background:var(--skr-surface);
  border:1px solid var(--skr-border);
  padding:24px;margin-bottom:16px;
}
.skr-card-title{
  font-size:10px;color:var(--skr-text-dim);
  letter-spacing:2px;text-transform:uppercase;
  margin-bottom:12px;
}
.skr-card-value{
  font-family:var(--skr-font-heading);font-size:36px;
  font-weight:300;color:var(--skr-text);
}

/* Stats Row */
.skr-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px}

/* Two Column Layout */
.skr-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* Buttons */
.skr-btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:10px 20px;font-family:var(--skr-font-body);
  font-size:11px;letter-spacing:1.5px;text-transform:uppercase;
  cursor:pointer;transition:all 0.12s;border:none;
}
.skr-btn-primary{background:var(--skr-green);color:#fff}
.skr-btn-primary:hover{background:var(--skr-green-hover)}
.skr-btn-ghost{background:none;border:1px solid var(--skr-border);color:var(--skr-text-muted)}
.skr-btn-ghost:hover{border-color:var(--skr-border-hover);color:var(--skr-text)}

/* Tables */
.skr-table{width:100%;border-collapse:collapse}
.skr-table th{
  font-size:9px;color:var(--skr-text-dim);letter-spacing:2px;
  text-transform:uppercase;padding:10px 12px;text-align:left;
  border-bottom:1px solid var(--skr-border);
}
.skr-table td{
  padding:12px;font-size:13px;color:var(--skr-text-muted);
  border-bottom:1px solid var(--skr-border);
}
.skr-table tr:hover td{background:rgba(255,255,255,0.01)}

/* Status Pills */
.skr-pill{
  display:inline-block;padding:3px 10px;font-size:10px;
  letter-spacing:1px;text-transform:uppercase;
}
.skr-pill-green{background:rgba(58,148,100,0.1);color:#3A9464;border:1px solid rgba(58,148,100,0.2)}
.skr-pill-red{background:rgba(231,76,60,0.1);color:#e74c3c;border:1px solid rgba(231,76,60,0.2)}
.skr-pill-gold{background:rgba(201,185,154,0.1);color:#C9B99A;border:1px solid rgba(201,185,154,0.2)}

/* Notification badge */
.skr-badge{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:18px;height:18px;padding:0 5px;
  background:var(--skr-red);color:#fff;font-size:10px;
  font-weight:500;border-radius:9px;
}

/* Error state */
.skr-error-state{
  display:none;position:fixed;inset:0;z-index:9998;
  background:var(--skr-bg);
  flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:24px;
}
.skr-error-state.visible{display:flex}
.skr-error-state h2{font-family:var(--skr-font-heading);font-size:24px;font-weight:300;margin-bottom:8px}
.skr-error-state p{font-size:13px;color:var(--skr-text-muted);margin-bottom:24px;max-width:400px;line-height:1.6}

/* Responsive */
@media(max-width:768px){
  .skr-sidebar{transform:translateX(-100%);transition:transform 0.2s}
  .skr-sidebar.open{transform:translateX(0)}
  .skr-main{margin-left:0;padding:16px}
  .skr-grid-2{grid-template-columns:1fr}
  .skr-stats{grid-template-columns:1fr 1fr}
}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.12)}

/* Hide content until ready — CRITICAL */
.skr-main{opacity:0;transition:opacity 0.2s ease}
body.skr-ready .skr-main{opacity:1}

/* ═══════════════════════════════════════════
   LEADS PAGE SPECIFIC STYLES
   ═══════════════════════════════════════════ */

/* Stat cards with colored dots */
.stat-dot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-green{background:var(--skr-green);animation:pulse 2s ease-in-out infinite}
.dot-champagne{background:var(--skr-champagne)}
.dot-purple{background:#a78bfa}
.dot-blue{background:#3b82f6}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}

/* Filter row */
.filter-row{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.search-bar{
  flex:1;min-width:200px;max-width:340px;
  padding:12px 16px;font-family:var(--skr-font-body);
  font-size:14px;font-weight:300;color:var(--skr-text);
  background:rgba(255,255,255,0.03);border:1px solid var(--skr-border-hover);
  outline:none;transition:border-color .3s;
}
.search-bar::placeholder{color:var(--skr-text-dim);font-weight:200}
.search-bar:focus{border-color:rgba(58,148,100,.3)}
.filter-select{
  appearance:none;font-family:var(--skr-font-body);
  font-size:12px;font-weight:300;color:var(--skr-text);
  background:rgba(255,255,255,0.03);border:1px solid var(--skr-border-hover);
  padding:10px 16px;outline:none;cursor:pointer;min-width:140px;
}
.filter-select option{background:var(--skr-surface);color:var(--skr-text)}

/* Leads table */
.leads-table{width:100%;border-collapse:collapse;background:var(--skr-surface);border:1px solid var(--skr-border)}
.leads-table thead th{
  font-family:var(--skr-font-body);font-size:9px;font-weight:400;
  letter-spacing:2px;text-transform:uppercase;color:var(--skr-champagne);
  padding:14px 16px;text-align:left;border-bottom:1px solid var(--skr-border);
}
.leads-table tbody tr{border-bottom:1px solid var(--skr-border);transition:background .2s;cursor:pointer}
.leads-table tbody tr:hover{background:rgba(58,148,100,.04)}
.leads-table td{
  font-family:var(--skr-font-body);font-size:14px;font-weight:300;
  color:var(--skr-text);padding:14px 16px;vertical-align:middle;
}

/* Badges */
.badge{
  font-family:var(--skr-font-body);font-size:9px;font-weight:400;
  letter-spacing:1.5px;text-transform:uppercase;
  padding:3px 10px;display:inline-block;white-space:nowrap;
}
.badge-green{background:rgba(58,148,100,.12);color:var(--skr-green);border:1px solid rgba(58,148,100,.25)}
.badge-champagne{background:rgba(201,185,154,.12);color:var(--skr-champagne);border:1px solid rgba(201,185,154,.2)}
.badge-purple{background:rgba(167,139,250,.08);color:#a78bfa;border:1px solid rgba(167,139,250,.2)}
.badge-blue{background:rgba(59,130,246,.08);color:#3b82f6;border:1px solid rgba(59,130,246,.2)}
.badge-silver{background:rgba(255,255,255,.04);color:var(--skr-text-muted);border:1px solid var(--skr-border-hover)}
.badge-gold{background:rgba(212,160,23,.08);color:#d4a017;border:1px solid rgba(212,160,23,.15)}
.badge-red{background:rgba(192,57,43,.08);color:#e74c3c;border:1px solid rgba(192,57,43,.2)}

/* Pagination */
.pagination{display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding:16px 0}
.pagination-info{font-family:var(--skr-font-body);font-size:12px;font-weight:300;color:var(--skr-text-muted)}
.pagination-btns{display:flex;gap:8px}
.pagination-btn{
  font-family:var(--skr-font-body);font-size:10px;font-weight:300;
  letter-spacing:1.5px;text-transform:uppercase;color:var(--skr-text-muted);
  background:none;border:1px solid var(--skr-border);padding:8px 16px;
  cursor:pointer;transition:all .3s;
}
.pagination-btn:hover:not(:disabled){color:var(--skr-text);border-color:var(--skr-border-hover)}
.pagination-btn:disabled{opacity:.3;cursor:not-allowed}

/* Empty state */
.empty-state{padding:60px 24px;text-align:center;background:var(--skr-surface);border:1px solid var(--skr-border)}
.empty-icon{font-size:36px;margin-bottom:14px;opacity:.3}
.empty-msg{font-family:var(--skr-font-body);font-weight:300;font-size:14px;color:var(--skr-text-muted);line-height:1.7}

/* Spinner */
.spinner{width:24px;height:24px;border:2px solid rgba(58,148,100,.2);border-top-color:var(--skr-green);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Drawer */
.drawer{
  position:fixed;top:0;right:-520px;width:500px;height:100vh;
  background:var(--skr-surface);border-left:1px solid var(--skr-border);
  z-index:200;transition:right .35s cubic-bezier(0.22,1,0.36,1);
  overflow-y:auto;padding:32px;
}
.drawer.open{right:0}
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199;display:none}
.drawer-overlay.open{display:block}
.drawer-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
.drawer-name{font-family:var(--skr-font-heading);font-size:24px;font-weight:300;color:var(--skr-text)}
.drawer-email{color:var(--skr-champagne);font-size:13px;margin-top:4px}
.drawer-phone{color:var(--skr-text-muted);font-size:13px}
.drawer-close{background:none;border:none;color:var(--skr-text-muted);font-size:20px;cursor:pointer;transition:color .2s;padding:4px}
.drawer-close:hover{color:var(--skr-text)}
.drawer-badges{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.drawer-section{background:rgba(255,255,255,.015);border:1px solid var(--skr-border);padding:20px;margin-bottom:16px}
.drawer-section-title{font-family:var(--skr-font-heading);font-size:16px;font-weight:400;color:var(--skr-text);margin-bottom:12px}
.drawer-note{color:var(--skr-text-muted);font-size:13px;line-height:1.6}
.drawer-activity-item{padding:6px 0;font-size:12px;color:var(--skr-text-muted);border-bottom:1px solid var(--skr-border)}
.drawer-status-select{
  appearance:none;width:100%;font-family:var(--skr-font-body);
  font-size:13px;font-weight:300;color:var(--skr-text);
  background:rgba(255,255,255,.03);border:1px solid var(--skr-border-hover);
  padding:10px 14px;outline:none;cursor:pointer;
}
.drawer-status-select option{background:var(--skr-surface);color:var(--skr-text)}

/* Responsive overrides */
@media(max-width:1100px){.skr-stats{grid-template-columns:repeat(2,1fr)}}
@media(max-width:900px){
  .skr-stats{grid-template-columns:repeat(2,1fr)}
  .leads-table{display:block;overflow-x:auto}
  .drawer{width:100%;right:-100%}
}
@media(max-width:480px){.skr-stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Loading screen — visible immediately -->
  <div class="skr-loader" id="skr-loader">
    <div class="skr-loader-logo">Silver Key <em>Realty</em></div>
    <div class="skr-loader-bar"><div class="skr-loader-fill"></div></div>
    <div class="skr-loader-text">Loading...</div>
  </div>

  <!-- Error state — hidden by default -->
  <div class="skr-error-state" id="skr-error-state">
    <div class="skr-loader-logo">Silver Key <em>Realty</em></div>
    <h2>Something went wrong</h2>
    <p>The page didn't load correctly. This usually fixes itself — try refreshing.</p>
    <button class="skr-btn skr-btn-primary" onclick="window.location.reload()">Refresh Page</button>
    <button class="skr-btn skr-btn-ghost" onclick="window.location.href='/admin/'" style="margin-top:8px">Back to Login</button>
  </div>

  <!-- Shell wrapper -->
  <div class="skr-shell">
    <!-- Sidebar gets injected here by SKR_SHELL -->
    
    <main class="skr-main">
      <div class="skr-page-header">
        <div class="skr-page-meta">
          <div id="current-date"></div>
          <div class="system-status">● SYSTEM ONLINE</div>
        </div>
        <h1 class="skr-page-title">Lead <em>Pipeline</em></h1>
        <p class="skr-page-sub" id="greeting"></p>
      </div>

      <div class="skr-stats">
        <div class="skr-card">
          <div class="skr-card-title"><span class="stat-dot dot-green"></span> Total Leads</div>
          <div class="skr-card-value" id="statTotal" style="color:var(--skr-green)">—</div>
        </div>
        <div class="skr-card">
          <div class="skr-card-title"><span class="stat-dot dot-champagne"></span> New</div>
          <div class="skr-card-value" id="statNew" style="color:var(--skr-champagne)">—</div>
        </div>
        <div class="skr-card">
          <div class="skr-card-title"><span class="stat-dot dot-purple"></span> Qualified</div>
          <div class="skr-card-value" id="statQualified" style="color:#a78bfa">—</div>
        </div>
        <div class="skr-card">
          <div class="skr-card-title"><span class="stat-dot dot-blue"></span> Converted</div>
          <div class="skr-card-value" id="statConverted" style="color:#3b82f6">—</div>
        </div>
      </div>

      <div class="filter-row">
        <input type="text" class="search-bar" id="searchInput" placeholder="Search by name or email...">
        <select class="filter-select" id="filterPathway">
          <option value="">All Pathways</option>
          <option value="buyer">Buyer</option>
          <option value="seller">Seller</option>
          <option value="investor">Investor</option>
          <option value="renter">Renter</option>
          <option value="general">General</option>
        </select>
        <select class="filter-select" id="filterStatus">
          <option value="">All Statuses</option>
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="nurturing">Nurturing</option>
          <option value="converted">Converted</option>
          <option value="lost">Lost</option>
        </select>
      </div>

      <div id="tableContainer">
        <table class="leads-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Pathway</th>
              <th>Score</th>
              <th>Status</th>
              <th>Source</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="leadsBody">
            <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--skr-text-muted)"><div class="spinner" style="margin:0 auto"></div></td></tr>
          </tbody>
        </table>
      </div>

      <div id="emptyState" style="display:none">
        <div class="empty-state">
          <div class="empty-icon">◎</div>
          <div class="empty-msg">No leads found.<br>Adjust your filters or wait for new website inquiries.</div>
        </div>
      </div>

      <div class="pagination" id="pagination" style="display:none">
        <div class="pagination-info" id="paginationInfo">Page 1</div>
        <div class="pagination-btns">
          <button class="pagination-btn" id="prevBtn" disabled>Previous</button>
          <button class="pagination-btn" id="nextBtn">Next</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Lead detail drawer -->
  <div class="drawer" id="leadDrawer">
    <div id="drawerContent"></div>
  </div>
  <div class="drawer-overlay" id="drawerOverlay"></div>

  <!-- Scripts — loaded at the bottom so HTML renders first -->
  <script src="../../assets/js/admin-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../assets/includes/skr-shell.js"></script>
  <script src="../assets/js/skr-auth.js"></script>
  <script>
    var shell = SKR_SHELL.init({ activePage: 'leads' });

    SKR_AUTH.guard(function(member, sb) {
      shell.render(member);

      document.getElementById('greeting').textContent = 'Good ' + getTimeOfDay() + ', ' + member.first_name;
      document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      loadPageData(member, sb);
    });

    function getTimeOfDay() {
      var h = new Date().getHours();
      if (h < 12) return 'morning';
      if (h < 17) return 'afternoon';
      return 'evening';
    }

    var currentPage = 1;
    var pageSize = 25;

    function pathwayBadge(p) {
      var map = { buyer: 'badge-green', seller: 'badge-champagne', investor: 'badge-purple', renter: 'badge-blue', general: 'badge-silver' };
      return '<span class="badge ' + (map[p] || 'badge-silver') + '">' + (p || 'general') + '</span>';
    }

    function statusBadge(s) {
      var map = { new: 'badge-green', contacted: 'badge-champagne', qualified: 'badge-purple', nurturing: 'badge-blue', converted: 'badge-gold', lost: 'badge-red' };
      return '<span class="badge ' + (map[s] || 'badge-silver') + '">' + (s || 'unknown') + '</span>';
    }

    function timeAgo(ts) {
      var diff = Date.now() - new Date(ts).getTime();
      var mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      var hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      var days = Math.floor(hrs / 24);
      if (days < 30) return days + 'd ago';
      return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    async function loadPageData(member, sb) {
      loadLeads();
      loadStats();
    }

    async function loadLeads() {
      var tableContainer = document.getElementById('tableContainer');
      var emptyState = document.getElementById('emptyState');
      var paginationEl = document.getElementById('pagination');

      tableContainer.style.display = 'block';
      emptyState.style.display = 'none';
      paginationEl.style.display = 'none';

      var tbody = document.getElementById('leadsBody');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--skr-text-muted)"><div class="spinner" style="margin:0 auto"></div></td></tr>';

      var search = document.getElementById('searchInput').value;
      var pathway = document.getElementById('filterPathway').value;
      var status = document.getElementById('filterStatus').value;

      var url = '/api/leads/list?page=' + currentPage + '&limit=' + pageSize;
      if (search) url += '&search=' + encodeURIComponent(search);
      if (pathway) url += '&pathway=' + pathway;
      if (status) url += '&status=' + status;

      try {
        var data = await skrAPI(url);

        document.getElementById('greeting').textContent = (data.total || 0) + ' lead' + (data.total !== 1 ? 's' : '') + ' in pipeline';

        if (!data.leads || data.leads.length === 0) {
          tableContainer.style.display = 'none';
          emptyState.style.display = 'block';
          return;
        }

        tbody.innerHTML = data.leads.map(function(l) {
          return '<tr onclick="window._openLead(\'' + l.id + '\')">'
            + '<td style="font-weight:400">' + (l.first_name || '') + ' ' + (l.last_name || '') + '</td>'
            + '<td style="color:var(--skr-champagne)">' + (l.email || '') + '</td>'
            + '<td>' + pathwayBadge(l.pathway) + '</td>'
            + '<td>' + (l.lead_score || '—') + '</td>'
            + '<td>' + statusBadge(l.status) + '</td>'
            + '<td style="color:var(--skr-text-muted);font-size:12px">' + (l.source || 'website') + '</td>'
            + '<td style="color:var(--skr-text-muted);font-size:12px">' + timeAgo(l.created_at) + '</td>'
            + '</tr>';
        }).join('');

        if (data.totalPages > 1) {
          paginationEl.style.display = 'flex';
          document.getElementById('paginationInfo').textContent = 'Page ' + data.page + ' of ' + data.totalPages + ' · ' + data.total + ' leads';
          document.getElementById('prevBtn').disabled = data.page <= 1;
          document.getElementById('nextBtn').disabled = data.page >= data.totalPages;
        }
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--skr-red)">Failed to load leads.</td></tr>';
      }
    }

    async function loadStats() {
      try {
        var data = await skrAPI('/api/dashboard/stats');
        document.getElementById('statTotal').textContent = data.counts.leads || 0;

        var allLeads = await skrAPI('/api/leads/list?limit=1&status=new');
        document.getElementById('statNew').textContent = allLeads.total || 0;

        var qualified = await skrAPI('/api/leads/list?limit=1&status=qualified');
        document.getElementById('statQualified').textContent = qualified.total || 0;

        var converted = await skrAPI('/api/leads/list?limit=1&status=converted');
        document.getElementById('statConverted').textContent = converted.total || 0;
      } catch(e) {}
    }

    window._openLead = async function(id) {
      var drawer = document.getElementById('leadDrawer');
      var overlay = document.getElementById('drawerOverlay');
      var content = document.getElementById('drawerContent');

      drawer.classList.add('open');
      overlay.classList.add('open');
      content.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:200px"><div class="spinner"></div></div>';

      try {
        var data = await skrAPI('/api/leads/detail?id=' + id);
        var l = data.lead;

        var html = '<div class="drawer-header">'
          + '<div>'
          + '<div class="drawer-name">' + (l.first_name || '') + ' ' + (l.last_name || '') + '</div>'
          + '<div class="drawer-email">' + (l.email || '') + '</div>'
          + (l.phone ? '<div class="drawer-phone">' + l.phone + '</div>' : '')
          + '</div>'
          + '<button class="drawer-close" onclick="window._closeDrawer()">✕</button>'
          + '</div>';

        html += '<div class="drawer-badges">' + pathwayBadge(l.pathway) + statusBadge(l.status)
          + '<span style="color:var(--skr-text-muted);font-size:12px;padding:3px 0">Score: ' + (l.lead_score || '—') + '</span></div>';

        if (l.notes) {
          html += '<div class="drawer-section"><div class="drawer-section-title">Notes</div><p class="drawer-note">' + l.notes + '</p></div>';
        }

        html += '<div style="margin-bottom:16px">'
          + '<label style="display:block;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--skr-text-muted);margin-bottom:6px">Update Status</label>'
          + '<select class="drawer-status-select" onchange="window._updateLead(\'' + l.id + '\',\'status\',this.value)">'
          + ['new','contacted','qualified','nurturing','converted','lost'].map(function(s) {
              return '<option value="' + s + '"' + (s === l.status ? ' selected' : '') + '>' + s + '</option>';
            }).join('')
          + '</select></div>';

        if (data.deals && data.deals.length > 0) {
          html += '<div class="drawer-section"><div class="drawer-section-title">Deals (' + data.deals.length + ')</div>';
          data.deals.forEach(function(d) {
            html += '<div style="padding:8px 0;border-bottom:1px solid var(--skr-border)">'
              + '<span style="color:var(--skr-text);font-weight:400">' + d.deal_name + '</span> '
              + '<span class="badge badge-green">' + d.status + '</span>'
              + (d.deal_value ? ' <span style="color:var(--skr-green);margin-left:8px">$' + Number(d.deal_value).toLocaleString() + '</span>' : '')
              + '</div>';
          });
          html += '</div>';
        }

        if (data.showings && data.showings.length > 0) {
          html += '<div class="drawer-section"><div class="drawer-section-title">Showings (' + data.showings.length + ')</div>';
          data.showings.forEach(function(s) {
            html += '<div style="padding:8px 0;border-bottom:1px solid var(--skr-border)">'
              + '<span style="color:var(--skr-text)">' + (s.skr_properties ? s.skr_properties.address_line1 : 'Unknown') + ', ' + (s.skr_properties ? s.skr_properties.city : '') + '</span>'
              + ' <span style="color:var(--skr-text-muted);font-size:12px">' + new Date(s.scheduled_at).toLocaleDateString() + '</span></div>';
          });
          html += '</div>';
        }

        html += '<div class="drawer-section"><div class="drawer-section-title">Activity</div>';
        if (data.activity && data.activity.length > 0) {
          data.activity.forEach(function(a) {
            html += '<div class="drawer-activity-item">' + a.action + ' · ' + timeAgo(a.created_at) + '</div>';
          });
        } else {
          html += '<p style="text-align:center;padding:16px;color:var(--skr-text-muted);font-size:13px">No activity yet</p>';
        }
        html += '</div>';

        content.innerHTML = html;
      } catch(e) {
        content.innerHTML = '<p style="text-align:center;padding:40px;color:var(--skr-red)">Failed to load lead details.</p>';
      }
    };

    window._closeDrawer = function() {
      document.getElementById('leadDrawer').classList.remove('open');
      document.getElementById('drawerOverlay').classList.remove('open');
    };

    window._updateLead = async function(id, field, value) {
      await skrAPI('/api/leads/update', { method: 'PATCH', body: { id: id, [field]: value } });
      loadLeads();
    };

    document.getElementById('drawerOverlay').addEventListener('click', window._closeDrawer);
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') window._closeDrawer(); });

    var searchTimer;
    document.getElementById('searchInput').addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(function() { currentPage = 1; loadLeads(); }, 400);
    });
    document.getElementById('filterPathway').addEventListener('change', function() { currentPage = 1; loadLeads(); });
    document.getElementById('filterStatus').addEventListener('change', function() { currentPage = 1; loadLeads(); });
    document.getElementById('prevBtn').addEventListener('click', function() { if (currentPage > 1) { currentPage--; loadLeads(); } });
    document.getElementById('nextBtn').addEventListener('click', function() { currentPage++; loadLeads(); });
  </script>
</body>
</html>
