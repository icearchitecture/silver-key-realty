<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silver Key Realty — Signing In</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:#111111; font-family:'Outfit',sans-serif; color:#F0EBE3;
    }
    .container { text-align:center; max-width:400px; padding:48px 32px; }
    .logo { font-family:Georgia,serif; font-size:20px; color:#F0EBE3; margin-bottom:40px; }
    .logo em { color:#C9B99A; }
    .spinner {
      width:36px; height:36px; border-radius:50%;
      border:2px solid rgba(58,148,100,0.15); border-top-color:#3A9464;
      animation:spin 0.8s linear infinite; margin:0 auto 20px;
    }
    @keyframes spin { to { transform:rotate(360deg) } }
    #status { font-size:14px; color:#9A8E80; }
    .error { color:#e74c3c; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">Silver Key <em>Realty</em></div>
    <div class="spinner" id="spinner"></div>
    <div id="status">Verifying your access...</div>
  </div>

  <script src="../../../assets/js/admin-config.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const statusEl = document.getElementById('status');
    const spinnerEl = document.getElementById('spinner');

    function showError(msg) {
      spinnerEl.style.display = 'none';
      statusEl.className = 'error';
      statusEl.textContent = msg;
    }

    async function handleCallback() {
      try {
        const config = window.SKR_CONFIG || {};
        const supabaseUrl = config.SUPABASE_URL || 'https://onhwgirbmoxaquxpkfie.supabase.co';
        const supabaseKey = config.SUPABASE_ANON_KEY || '';

        if (!supabaseKey) {
          showError('Configuration error. Please contact support.');
          return;
        }

        const supabase = createClient(supabaseUrl, supabaseKey);

        // Step 1: Handle OAuth redirect — extract tokens from URL hash
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');

        // Also handle code-based OAuth (PKCE flow)
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
          const { error: codeError } = await supabase.auth.exchangeCodeForSession(code);
          if (codeError) {
            console.error('Code exchange failed:', codeError);
            showError('Sign-in failed. Please try again.');
            setTimeout(() => window.location.href = '/admin/?error=callback_failed', 2000);
            return;
          }
        } else if (accessToken) {
          const { error: sessionError } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken
          });
          if (sessionError) {
            console.error('Session set failed:', sessionError);
            showError('Sign-in failed. Please try again.');
            setTimeout(() => window.location.href = '/admin/?error=callback_failed', 2000);
            return;
          }
        }

        // Step 2: Get the authenticated user
        statusEl.textContent = 'Checking credentials...';
        const { data: { user }, error: userError } = await supabase.auth.getUser();

        if (userError || !user) {
          console.error('No authenticated user:', userError);
          showError('Authentication failed. Please try again.');
          setTimeout(() => window.location.href = '/admin/?error=no_user', 2000);
          return;
        }

        // Step 3: SECURITY GATE — Check team membership
        statusEl.textContent = 'Verifying team access...';
        let member = null;

        // First try: match by auth_user_id
        const { data: byAuthId } = await supabase
          .from('skr_team_members')
          .select('id, first_name, last_name, is_active, role_id, tenant_id')
          .eq('auth_user_id', user.id)
          .single();

        if (byAuthId) {
          member = byAuthId;
        } else if (user.email) {
          // Second try: match by email (first-time SSO where auth_user_id isn't linked yet)
          const { data: byEmail } = await supabase
            .from('skr_team_members')
            .select('id, first_name, last_name, is_active, role_id, tenant_id')
            .eq('email', user.email)
            .single();

          if (byEmail) {
            // Link auth_user_id for future logins
            await supabase
              .from('skr_team_members')
              .update({ auth_user_id: user.id })
              .eq('id', byEmail.id);
            member = byEmail;
          }
        }

        if (!member) {
          console.warn('Access denied: No team record for', user.email);
          await supabase.auth.signOut();
          window.location.href = '/admin/access-denied/';
          return;
        }

        if (!member.is_active) {
          console.warn('Access denied: Deactivated account', user.email);
          await supabase.auth.signOut();
          window.location.href = '/admin/access-denied/?reason=deactivated';
          return;
        }

        // Step 4: APPROVED — store member data and redirect
        statusEl.textContent = 'Welcome back, ' + member.first_name + '...';

        try {
          const { data: roleData } = await supabase
            .from('skr_roles')
            .select('role_name, permission_level')
            .eq('id', member.role_id)
            .single();

          sessionStorage.setItem('skr_member', JSON.stringify({
            id: member.id,
            firstName: member.first_name,
            lastName: member.last_name,
            email: user.email,
            role: roleData?.role_name || 'unknown',
            permissionLevel: roleData?.permission_level || 0,
            tenantId: member.tenant_id,
            authUserId: user.id
          }));
          sessionStorage.setItem('skr_member_ts', Date.now().toString());
        } catch (e) {
          // Cache failure is not fatal — skr-auth.js will re-fetch
        }

        setTimeout(() => {
          window.location.href = '/admin/dashboard/';
        }, 600);

      } catch (err) {
        console.error('Callback error:', err);
        showError('Something went wrong. Redirecting...');
        try {
          const supabase = createClient(
            window.SKR_CONFIG?.SUPABASE_URL || 'https://onhwgirbmoxaquxpkfie.supabase.co',
            window.SKR_CONFIG?.SUPABASE_ANON_KEY || ''
          );
          await supabase.auth.signOut();
        } catch (e) {}
        setTimeout(() => window.location.href = '/admin/?error=callback_failed', 2000);
      }
    }

    handleCallback();
  </script>
</body>
</html>
