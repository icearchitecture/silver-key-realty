<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silver Key Realty â€” Command Center</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/tokens.css">
  <link rel="stylesheet" href="../../assets/css/base.css">
  <link rel="stylesheet" href="../../assets/css/admin.css">
</head>
<body>
  <div id="skr-loader" class="skr-loader"><div class="skr-spinner"></div></div>

  <div id="skr-main" class="skr-shell" style="display:none">
    <aside id="skr-sidebar" class="skr-sidebar"></aside>

    <main class="skr-content">
      <div class="skr-page-header" style="display:flex;justify-content:space-between;align-items:flex-end">
        <div>
          <h1 class="skr-page-title">Command <em>Center</em></h1>
          <p class="skr-page-sub" id="dash-greeting">Welcome back</p>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:#9A8E80" id="dash-date"></div>
          <div style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#3A9464;margin-top:4px">&#9679; System Online</div>
        </div>
      </div>

      <div id="dash-stats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:32px">
        <div class="skr-card" style="text-align:center"><div style="font-size:11px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Leads</div><div style="font-family:'Cormorant Garamond',serif;font-size:36px;color:#3A9464;margin-top:4px">&mdash;</div></div>
        <div class="skr-card" style="text-align:center"><div style="font-size:11px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Active Deals</div><div style="font-family:'Cormorant Garamond',serif;font-size:36px;color:#C9B99A;margin-top:4px">&mdash;</div></div>
        <div class="skr-card" style="text-align:center"><div style="font-size:11px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Properties</div><div style="font-family:'Cormorant Garamond',serif;font-size:36px;color:#a78bfa;margin-top:4px">&mdash;</div></div>
        <div class="skr-card" style="text-align:center"><div style="font-size:11px;color:#9A8E80;text-transform:uppercase;letter-spacing:1.5px">Team</div><div style="font-family:'Cormorant Garamond',serif;font-size:36px;color:#F0EBE3;margin-top:4px">&mdash;</div></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="skr-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <div class="skr-card-title">Recent Leads</div>
            <a href="/admin/leads/" style="font-size:11px;color:#C9B99A;text-decoration:none;text-transform:uppercase;letter-spacing:1px">View All &#8594;</a>
          </div>
          <div id="dash-leads"><p class="skr-empty">Loading...</p></div>
        </div>

        <div class="skr-card">
          <div class="skr-card-title" style="margin-bottom:16px">Recent Activity</div>
          <div id="dash-activity"><p class="skr-empty">Loading...</p></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:24px">
        <a href="/admin/leads/" class="skr-card" style="text-decoration:none;text-align:center;padding:20px;cursor:pointer">
          <div style="font-size:20px;margin-bottom:6px">&#9678;</div>
          <div style="color:#F0EBE3;font-size:13px">Leads</div>
        </a>
        <a href="/admin/deals/" class="skr-card" style="text-decoration:none;text-align:center;padding:20px;cursor:pointer">
          <div style="font-size:20px;margin-bottom:6px">&#11041;</div>
          <div style="color:#F0EBE3;font-size:13px">Deals</div>
        </a>
        <a href="/admin/properties/" class="skr-card" style="text-decoration:none;text-align:center;padding:20px;cursor:pointer">
          <div style="font-size:20px;margin-bottom:6px">&#8962;</div>
          <div style="color:#F0EBE3;font-size:13px">Properties</div>
        </a>
        <a href="/admin/source-drive/" class="skr-card" style="text-decoration:none;text-align:center;padding:20px;cursor:pointer">
          <div style="font-size:20px;margin-bottom:6px">&#9672;</div>
          <div style="color:#F0EBE3;font-size:13px">Search</div>
        </a>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../assets/js/admin-config.js"></script>
  <script src="../../assets/js/skr-auth.js"></script>
  <script>
    window.addEventListener('skr-ready', async function() {
      var u = window.SKR_USER;

      var hour = new Date().getHours();
      var greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
      document.getElementById('dash-greeting').textContent = greeting + ', ' + (u.member.first_name || u.displayName);
      document.getElementById('dash-date').textContent = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

      try {
        var stats = await skrAPI('/api/dashboard/stats');

        var cards = document.getElementById('dash-stats').children;
        var colors = ['#3A9464', '#C9B99A', '#a78bfa', '#F0EBE3'];
        var keys = ['leads', 'activeDeals', 'properties', 'team'];
        keys.forEach(function(k, i) {
          cards[i].querySelector('div:last-child').textContent = (stats.counts && stats.counts[k]) || 0;
          cards[i].querySelector('div:last-child').style.color = colors[i];
        });

        var leadsContainer = document.getElementById('dash-leads');
        if (!stats.recentLeads || stats.recentLeads.length === 0) {
          leadsContainer.innerHTML = '<p class="skr-empty">No leads yet. Share your website to start receiving inquiries.</p>';
        } else {
          leadsContainer.innerHTML = stats.recentLeads.slice(0, 8).map(function(l) {
            return '<a href="/admin/leads/" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03);text-decoration:none">'
              + '<div>'
              + '<div style="color:#F0EBE3;font-size:13px;font-weight:400">' + (l.first_name || '') + ' ' + (l.last_name || '') + '</div>'
              + '<div style="font-size:11px;color:#7A6E60;margin-top:2px">' + timeAgo(l.created_at) + '</div>'
              + '</div>'
              + '<span class="skr-badge badge-' + (l.pathway || 'general') + '">' + (l.pathway || 'general') + '</span>'
              + '</a>';
          }).join('');
        }

        var actContainer = document.getElementById('dash-activity');
        if (!stats.activity || stats.activity.length === 0) {
          actContainer.innerHTML = '<p class="skr-empty">No activity recorded yet.</p>';
        } else {
          actContainer.innerHTML = stats.activity.slice(0, 10).map(function(a) {
            return '<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.02);font-size:12px">'
              + '<span style="color:#C9B99A">' + formatAction(a.action) + '</span>'
              + '<span style="color:#7A6E60;margin-left:8px">' + timeAgo(a.created_at) + '</span>'
              + '</div>';
          }).join('');
        }
      } catch (err) {
        console.warn('[SKR Dashboard] Stats load failed, falling back to direct queries:', err.message);
        loadStatsDirect();
      }
    });

    async function loadStatsDirect() {
      var sb = window.SKR_SUPA;
      var cards = document.getElementById('dash-stats').children;

      try {
        var results = await Promise.all([
          sb.from('skr_leads').select('id', { count: 'exact', head: true }),
          sb.from('skr_deals').select('id', { count: 'exact', head: true }).in('status', ['active','under_contract','pending']),
          sb.from('skr_properties').select('id', { count: 'exact', head: true }),
          sb.from('skr_team_members').select('id', { count: 'exact', head: true }).eq('is_active', true),
        ]);

        var colors = ['#3A9464', '#C9B99A', '#a78bfa', '#F0EBE3'];
        results.forEach(function(r, i) {
          cards[i].querySelector('div:last-child').textContent = r.count || 0;
          cards[i].querySelector('div:last-child').style.color = colors[i];
        });
      } catch (e) { console.warn('[SKR] Direct stats failed:', e); }

      try {
        var leadResult = await sb.from('skr_leads').select('id, first_name, last_name, pathway, created_at').order('created_at', { ascending: false }).limit(8);
        var leadsContainer = document.getElementById('dash-leads');
        if (leadResult.data && leadResult.data.length > 0) {
          leadsContainer.innerHTML = leadResult.data.map(function(l) {
            return '<a href="/admin/leads/" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03);text-decoration:none">'
              + '<div><div style="color:#F0EBE3;font-size:13px;font-weight:400">' + (l.first_name || '') + ' ' + (l.last_name || '') + '</div>'
              + '<div style="font-size:11px;color:#7A6E60;margin-top:2px">' + timeAgo(l.created_at) + '</div></div>'
              + '<span class="skr-badge badge-' + (l.pathway || 'general') + '">' + (l.pathway || 'general') + '</span></a>';
          }).join('');
        } else {
          leadsContainer.innerHTML = '<p class="skr-empty">No leads yet.</p>';
        }
      } catch (e) { console.warn('[SKR] Leads fallback failed:', e); }

      try {
        var actResult = await sb.from('skr_audit_log').select('action, created_at').order('created_at', { ascending: false }).limit(10);
        var actContainer = document.getElementById('dash-activity');
        if (actResult.data && actResult.data.length > 0) {
          actContainer.innerHTML = actResult.data.map(function(a) {
            return '<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.02);font-size:12px">'
              + '<span style="color:#C9B99A">' + formatAction(a.action) + '</span>'
              + '<span style="color:#7A6E60;margin-left:8px">' + timeAgo(a.created_at) + '</span></div>';
          }).join('');
        } else {
          actContainer.innerHTML = '<p class="skr-empty">No activity recorded yet.</p>';
        }
      } catch (e) { console.warn('[SKR] Activity fallback failed:', e); }
    }

    function formatAction(a) {
      var map = { lead_created:'New lead received', deal_created:'Deal created', team_member_added:'Team member added', login_success:'Successful login', permission_changed:'Permission updated', mailbox_provisioned:'Mailbox provisioned' };
      return map[a] || (a || '').replace(/_/g, ' ');
    }

    function timeAgo(ts) {
      var d = Date.now() - new Date(ts).getTime();
      var m = Math.floor(d / 60000);
      if (m < 1) return 'just now';
      if (m < 60) return m + 'm ago';
      var h = Math.floor(m / 60);
      if (h < 24) return h + 'h ago';
      return Math.floor(h / 24) + 'd ago';
    }
  </script>
</body>
</html>
