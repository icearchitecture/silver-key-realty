<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deals — Silver Key Realty</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <style>
/* ═══════════════════════════════════════════
   SKR CRITICAL CSS — Inlined in every page
   If this renders, the page looks right.
   ═══════════════════════════════════════════ */

/* Reset */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

/* Base */
:root{
  --skr-bg:#111111;
  --skr-surface:#1A1A1A;
  --skr-surface-2:#1E1E1E;
  --skr-border:rgba(255,255,255,0.04);
  --skr-border-hover:rgba(255,255,255,0.08);
  --skr-text:#F0EBE3;
  --skr-text-muted:#9A8E80;
  --skr-text-dim:#7A6E60;
  --skr-champagne:#C9B99A;
  --skr-green:#3A9464;
  --skr-green-hover:#2d7a52;
  --skr-red:#e74c3c;
  --skr-sidebar-w:220px;
  --skr-font-body:'Outfit',system-ui,-apple-system,sans-serif;
  --skr-font-heading:'Cormorant Garamond',Georgia,serif;
  --skr-font-logo:Georgia,serif;
}

html{height:100%}
body{
  min-height:100vh;background:var(--skr-bg);
  font-family:var(--skr-font-body);color:var(--skr-text);
  -webkit-font-smoothing:antialiased;
}

/* Loading Screen — visible by default, hidden when page is ready */
.skr-loader{
  position:fixed;inset:0;z-index:9999;
  background:var(--skr-bg);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  transition:opacity 0.3s ease;
}
.skr-loader.hidden{opacity:0;pointer-events:none}
.skr-loader-logo{font-family:var(--skr-font-logo);font-size:22px;color:var(--skr-text);margin-bottom:24px}
.skr-loader-logo em{color:var(--skr-champagne)}
.skr-loader-bar{width:120px;height:2px;background:rgba(255,255,255,0.06);overflow:hidden;border-radius:1px}
.skr-loader-fill{width:30%;height:100%;background:var(--skr-green);animation:skr-load 1.2s ease-in-out infinite}
@keyframes skr-load{0%{transform:translateX(-100%)}100%{transform:translateX(400%)}}
.skr-loader-text{font-size:11px;color:var(--skr-text-dim);margin-top:12px;letter-spacing:1px}

/* Shell Layout */
.skr-shell{display:flex;min-height:100vh}

/* Sidebar */
.skr-sidebar{
  width:var(--skr-sidebar-w);min-height:100vh;
  background:var(--skr-surface);
  border-right:1px solid var(--skr-border);
  display:flex;flex-direction:column;
  position:fixed;left:0;top:0;bottom:0;
  z-index:100;
  overflow-y:auto;
}
.skr-sidebar-logo{
  padding:24px 20px 20px;
  font-family:var(--skr-font-logo);font-size:16px;
  color:var(--skr-text);border-bottom:1px solid var(--skr-border);
}
.skr-sidebar-logo em{color:var(--skr-champagne)}

.skr-sidebar-nav{padding:12px 0;flex:1}
.skr-sidebar-link{
  display:flex;align-items:center;gap:10px;
  padding:10px 20px;font-size:13px;color:var(--skr-text-muted);
  text-decoration:none;transition:all 0.12s;
  border-left:2px solid transparent;
}
.skr-sidebar-link:hover{color:var(--skr-text);background:rgba(255,255,255,0.02)}
.skr-sidebar-link.active{
  color:var(--skr-champagne);
  border-left-color:var(--skr-green);
  background:rgba(58,148,100,0.04);
}
.skr-sidebar-link .icon{width:16px;text-align:center;font-size:12px;opacity:0.6}

.skr-sidebar-section{
  font-size:9px;color:var(--skr-text-dim);letter-spacing:2px;
  text-transform:uppercase;padding:16px 20px 6px;
}

.skr-sidebar-user{
  padding:16px 20px;border-top:1px solid var(--skr-border);
  font-size:12px;
}
.skr-sidebar-user-name{color:var(--skr-text);font-weight:400}
.skr-sidebar-user-role{color:var(--skr-text-dim);font-size:10px;letter-spacing:1px;text-transform:uppercase;margin-top:2px}
.skr-sidebar-signout{
  display:inline-block;margin-top:8px;font-size:10px;
  color:var(--skr-text-dim);cursor:pointer;background:none;
  border:none;font-family:var(--skr-font-body);letter-spacing:1px;
  text-transform:uppercase;
}
.skr-sidebar-signout:hover{color:var(--skr-red)}

/* Main Content */
.skr-main{
  flex:1;margin-left:var(--skr-sidebar-w);
  padding:32px;min-height:100vh;
}

/* Page Header */
.skr-page-header{margin-bottom:32px}
.skr-page-title{
  font-family:var(--skr-font-heading);font-size:32px;font-weight:300;
  color:var(--skr-text);
}
.skr-page-title em{color:var(--skr-champagne)}
.skr-page-sub{font-size:13px;color:var(--skr-text-muted);margin-top:4px}
.skr-page-meta{
  float:right;text-align:right;font-size:11px;color:var(--skr-text-dim);
}
.skr-page-meta .system-status{color:var(--skr-green);font-size:10px;letter-spacing:1px}

/* Cards */
.skr-card{
  background:var(--skr-surface);
  border:1px solid var(--skr-border);
  padding:24px;margin-bottom:16px;
}
.skr-card-title{
  font-size:10px;color:var(--skr-text-dim);
  letter-spacing:2px;text-transform:uppercase;
  margin-bottom:12px;
}
.skr-card-value{
  font-family:var(--skr-font-heading);font-size:36px;
  font-weight:300;color:var(--skr-text);
}

/* Stats Row */
.skr-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px}

/* Two Column Layout */
.skr-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* Buttons */
.skr-btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:10px 20px;font-family:var(--skr-font-body);
  font-size:11px;letter-spacing:1.5px;text-transform:uppercase;
  cursor:pointer;transition:all 0.12s;border:none;
}
.skr-btn-primary{background:var(--skr-green);color:#fff}
.skr-btn-primary:hover{background:var(--skr-green-hover)}
.skr-btn-ghost{background:none;border:1px solid var(--skr-border);color:var(--skr-text-muted)}
.skr-btn-ghost:hover{border-color:var(--skr-border-hover);color:var(--skr-text)}

/* Tables */
.skr-table{width:100%;border-collapse:collapse}
.skr-table th{
  font-size:9px;color:var(--skr-text-dim);letter-spacing:2px;
  text-transform:uppercase;padding:10px 12px;text-align:left;
  border-bottom:1px solid var(--skr-border);
}
.skr-table td{
  padding:12px;font-size:13px;color:var(--skr-text-muted);
  border-bottom:1px solid var(--skr-border);
}
.skr-table tr:hover td{background:rgba(255,255,255,0.01)}

/* Status Pills */
.skr-pill{
  display:inline-block;padding:3px 10px;font-size:10px;
  letter-spacing:1px;text-transform:uppercase;
}
.skr-pill-green{background:rgba(58,148,100,0.1);color:#3A9464;border:1px solid rgba(58,148,100,0.2)}
.skr-pill-red{background:rgba(231,76,60,0.1);color:#e74c3c;border:1px solid rgba(231,76,60,0.2)}
.skr-pill-gold{background:rgba(201,185,154,0.1);color:#C9B99A;border:1px solid rgba(201,185,154,0.2)}

/* Notification badge */
.skr-badge{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:18px;height:18px;padding:0 5px;
  background:var(--skr-red);color:#fff;font-size:10px;
  font-weight:500;border-radius:9px;
}

/* Error state */
.skr-error-state{
  display:none;position:fixed;inset:0;z-index:9998;
  background:var(--skr-bg);
  flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:24px;
}
.skr-error-state.visible{display:flex}
.skr-error-state h2{font-family:var(--skr-font-heading);font-size:24px;font-weight:300;margin-bottom:8px}
.skr-error-state p{font-size:13px;color:var(--skr-text-muted);margin-bottom:24px;max-width:400px;line-height:1.6}

/* Responsive */
@media(max-width:768px){
  .skr-sidebar{transform:translateX(-100%);transition:transform 0.2s}
  .skr-sidebar.open{transform:translateX(0)}
  .skr-main{margin-left:0;padding:16px}
  .skr-grid-2{grid-template-columns:1fr}
  .skr-stats{grid-template-columns:1fr 1fr}
}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.12)}

/* Hide content until ready — CRITICAL */
.skr-main{opacity:0;transition:opacity 0.2s ease}
body.skr-ready .skr-main{opacity:1}

/* ═══════════════════════════════════════════
   DEALS PAGE SPECIFIC STYLES
   ═══════════════════════════════════════════ */

.page-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px}
.btn-new{
  font-family:var(--skr-font-body);font-size:10px;font-weight:400;
  letter-spacing:2px;text-transform:uppercase;color:var(--skr-bg);
  background:var(--skr-text);padding:10px 22px;border:none;cursor:pointer;
  transition:all 0.4s cubic-bezier(0.22,1,0.36,1);white-space:nowrap;
}
.btn-new:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.3)}

.stat-card{
  padding:22px 20px;background:var(--skr-surface);
  border:1px solid var(--skr-border);transition:all 0.5s cubic-bezier(0.22,1,0.36,1);
}
.stat-card:hover{border-color:rgba(58,148,100,0.12);background:rgba(58,148,100,0.03)}
.stat-number{font-family:var(--skr-font-heading);font-size:28px;font-weight:300;color:var(--skr-text);margin-bottom:2px}
.stat-label{
  font-family:var(--skr-font-body);font-size:10px;font-weight:300;
  letter-spacing:2px;text-transform:uppercase;color:var(--skr-text-muted);
  display:flex;align-items:center;gap:8px;
}
.stat-dot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-green{background:var(--skr-green);animation:pulse 2s ease-in-out infinite}
.dot-champagne{background:var(--skr-champagne)}
.dot-purple{background:#a78bfa}
.dot-gold{background:#d4a017}
@keyframes pulse{0%,100%{opacity:0.4}50%{opacity:1}}

.search-bar{
  width:100%;padding:12px 16px;font-family:var(--skr-font-body);
  font-size:14px;font-weight:300;color:var(--skr-text);
  background:rgba(255,255,255,0.03);border:1px solid var(--skr-border-hover);
  outline:none;transition:border-color 0.3s;margin-bottom:16px;
}
.search-bar::placeholder{color:rgba(255,255,255,0.15);font-weight:200}
.search-bar:focus{border-color:rgba(58,148,100,0.3)}

.filter-tabs{display:flex;gap:0;margin-bottom:20px;overflow-x:auto;border-bottom:1px solid var(--skr-border)}
.filter-tab{
  font-family:var(--skr-font-body);font-size:11px;font-weight:300;
  letter-spacing:1.5px;text-transform:uppercase;color:var(--skr-text-muted);
  background:none;border:none;border-bottom:2px solid transparent;
  padding:10px 16px;cursor:pointer;transition:all 0.2s;white-space:nowrap;
}
.filter-tab:hover{color:var(--skr-text)}
.filter-tab.active{color:var(--skr-bg);background:var(--skr-text);border-bottom-color:var(--skr-text);font-weight:400}

.deals-table{width:100%;border-collapse:collapse;background:var(--skr-surface);border:1px solid var(--skr-border)}
.deals-table thead th{
  font-family:var(--skr-font-body);font-size:10px;font-weight:400;
  letter-spacing:2px;text-transform:uppercase;color:var(--skr-champagne);
  padding:14px 16px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06);
}
.deals-table tbody tr{border-bottom:1px solid rgba(255,255,255,0.02);transition:background 0.2s}
.deals-table tbody tr:hover{background:rgba(58,148,100,0.04)}
.deals-table tbody tr:last-child{border-bottom:none}
.deals-table td{
  font-family:var(--skr-font-body);font-size:14px;font-weight:300;
  color:var(--skr-text);padding:14px 16px;vertical-align:middle;
}
.deal-link{color:var(--skr-text);text-decoration:none;font-weight:400;transition:color 0.2s}
.deal-link:hover{color:var(--skr-green)}

.badge{
  font-family:var(--skr-font-body);font-size:9px;font-weight:400;
  letter-spacing:1.5px;text-transform:uppercase;padding:3px 10px;
  display:inline-block;white-space:nowrap;
}
.badge-green{background:rgba(58,148,100,0.12);color:var(--skr-green);border:1px solid rgba(58,148,100,0.25)}
.badge-champagne{background:rgba(201,185,154,0.12);color:var(--skr-champagne);border:1px solid rgba(201,185,154,0.2)}
.badge-purple{background:rgba(167,139,250,0.08);color:#a78bfa;border:1px solid rgba(167,139,250,0.2)}
.badge-silver{background:rgba(255,255,255,0.04);color:var(--skr-text-muted);border:1px solid rgba(255,255,255,0.08)}
.badge-gold{background:rgba(212,160,23,0.08);color:#d4a017;border:1px solid rgba(212,160,23,0.15)}
.badge-red{background:rgba(192,57,43,0.08);color:#e74c3c;border:1px solid rgba(192,57,43,0.2)}

.currency{font-family:var(--skr-font-heading);font-weight:400;color:var(--skr-champagne)}
.agents-cell{font-size:12px;font-weight:200;color:var(--skr-text-muted)}
.date-cell{font-size:12px;font-weight:200;color:var(--skr-text-muted)}

.pagination{display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding:16px 0}
.pagination-info{font-family:var(--skr-font-body);font-size:12px;font-weight:300;color:var(--skr-text-muted)}
.pagination-btns{display:flex;gap:8px}
.pagination-btn{
  font-family:var(--skr-font-body);font-size:10px;font-weight:300;
  letter-spacing:1.5px;text-transform:uppercase;color:var(--skr-text-muted);
  background:none;border:1px solid rgba(255,255,255,0.06);padding:8px 16px;
  cursor:pointer;transition:all 0.3s;
}
.pagination-btn:hover:not(:disabled){color:var(--skr-text);border-color:rgba(255,255,255,0.12)}
.pagination-btn:disabled{opacity:0.3;cursor:not-allowed}

.empty-state{padding:60px 24px;text-align:center;background:var(--skr-surface);border:1px solid var(--skr-border)}
.empty-icon{font-size:36px;margin-bottom:14px;opacity:0.3}
.empty-msg{font-family:var(--skr-font-body);font-weight:300;font-size:14px;color:var(--skr-text-muted);line-height:1.7}

.error-state{padding:40px 24px;text-align:center}
.error-msg{font-family:var(--skr-font-body);font-weight:300;font-size:14px;color:#c0392b;line-height:1.7}

.spinner{width:24px;height:24px;border:2px solid rgba(58,148,100,0.2);border-top-color:var(--skr-green);border-radius:50%;animation:spin 0.6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.modal-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);
  z-index:200;align-items:center;justify-content:center;padding:24px;
}
.modal-overlay.active{display:flex}
.modal{
  width:100%;max-width:480px;background:var(--skr-surface);
  border:1px solid rgba(255,255,255,0.06);padding:40px;position:relative;
}
.modal::after{
  content:'';position:absolute;bottom:0;left:15%;width:70%;height:1px;
  background:var(--skr-green);filter:blur(4px);opacity:0.3;
}
.modal-title{font-family:var(--skr-font-heading);font-size:22px;font-weight:400;color:var(--skr-text);margin-bottom:8px}
.modal-desc{font-family:var(--skr-font-body);font-weight:300;font-size:13px;color:var(--skr-text-muted);margin-bottom:28px}
.form-group{margin-bottom:18px}
.form-label{
  display:block;font-family:var(--skr-font-body);font-size:10px;font-weight:300;
  letter-spacing:2px;text-transform:uppercase;color:var(--skr-text-muted);margin-bottom:8px;
}
.form-input,.form-select{
  width:100%;font-family:var(--skr-font-body);font-weight:300;font-size:14px;
  color:var(--skr-text);background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);padding:12px 16px;outline:none;transition:border-color 0.3s;
}
.form-input:focus,.form-select:focus{border-color:rgba(58,148,100,0.3)}
.form-input::placeholder{color:rgba(255,255,255,0.15);font-weight:200}
.form-select{appearance:none;cursor:pointer}
.form-select option{background:var(--skr-surface);color:var(--skr-text)}
.modal-actions{display:flex;gap:12px;margin-top:28px}
.btn-primary{
  font-family:var(--skr-font-body);font-size:10px;font-weight:400;
  letter-spacing:2px;text-transform:uppercase;color:var(--skr-bg);
  background:var(--skr-text);padding:10px 22px;border:none;cursor:pointer;transition:all 0.4s;
}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.3)}
.btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none}
.btn-secondary{
  font-family:var(--skr-font-body);font-size:10px;font-weight:300;
  letter-spacing:2px;text-transform:uppercase;color:var(--skr-text-muted);
  background:transparent;border:1px solid rgba(255,255,255,0.06);
  padding:10px 22px;cursor:pointer;transition:all 0.4s;
}
.btn-secondary:hover{color:var(--skr-text);border-color:rgba(255,255,255,0.12)}
.modal-feedback{font-family:var(--skr-font-body);font-weight:300;font-size:13px;min-height:20px;margin-top:12px}
.modal-feedback.success{color:var(--skr-green)}
.modal-feedback.error{color:#c0392b}

@media(max-width:1100px){.skr-stats{grid-template-columns:repeat(2,1fr)}}
@media(max-width:900px){
  .skr-main{padding:20px}
  .skr-stats{grid-template-columns:repeat(2,1fr)}
  .page-header-row{flex-direction:column;gap:16px}
  .deals-table{display:block;overflow-x:auto}
}
@media(max-width:480px){.skr-stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="skr-loader" id="skr-loader">
    <div class="skr-loader-logo">Silver Key <em>Realty</em></div>
    <div class="skr-loader-bar"><div class="skr-loader-fill"></div></div>
    <div class="skr-loader-text">Loading...</div>
  </div>

  <!-- Error Fallback -->
  <div class="skr-error-state" id="skr-error-state">
    <div class="skr-loader-logo">Silver Key <em>Realty</em></div>
    <h2>Something went wrong</h2>
    <p>The page didn't load correctly. This usually fixes itself — try refreshing.</p>
    <button class="skr-btn skr-btn-primary" onclick="window.location.reload()">Refresh Page</button>
    <button class="skr-btn skr-btn-ghost" onclick="window.location.href='/admin/'" style="margin-top:8px">Back to Login</button>
  </div>

  <!-- Shell Wrapper -->
  <div class="skr-shell">
    <!-- Sidebar injected by SKR_SHELL -->

    <main class="skr-main">
      <div class="skr-page-header">
        <div class="page-header-row">
          <div>
            <h1 class="skr-page-title">Deal <em>Room</em></h1>
            <p class="skr-page-sub">Manage your active deals and pipeline</p>
          </div>
          <button class="btn-new" id="newDealBtn">+ New Deal</button>
        </div>
      </div>

      <div class="skr-stats">
        <div class="stat-card">
          <div class="stat-number" id="statOpen">&mdash;</div>
          <div class="stat-label"><span class="stat-dot dot-green"></span> Open Deals</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statContract">&mdash;</div>
          <div class="stat-label"><span class="stat-dot dot-champagne"></span> Under Contract</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statPending">&mdash;</div>
          <div class="stat-label"><span class="stat-dot dot-purple"></span> Pending Close</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statClosed">&mdash;</div>
          <div class="stat-label"><span class="stat-dot dot-gold"></span> Closed YTD</div>
        </div>
      </div>

      <input type="text" class="search-bar" id="searchInput" placeholder="Search deals...">

      <div class="filter-tabs" id="filterTabs">
        <button class="filter-tab active" data-filter="all">All</button>
        <button class="filter-tab" data-filter="new">New</button>
        <button class="filter-tab" data-filter="active">Active</button>
        <button class="filter-tab" data-filter="under_contract">Under Contract</button>
        <button class="filter-tab" data-filter="pending_close">Pending Close</button>
        <button class="filter-tab" data-filter="closed_won">Closed Won</button>
        <button class="filter-tab" data-filter="closed_lost">Closed Lost</button>
      </div>

      <div id="tableContainer">
        <table class="deals-table">
          <thead>
            <tr>
              <th>Deal Name</th>
              <th>Type</th>
              <th>Value</th>
              <th>Stage</th>
              <th>Agents</th>
              <th>Expected Close</th>
            </tr>
          </thead>
          <tbody id="dealsBody">
            <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--skr-text-muted)"><div class="spinner" style="margin:0 auto"></div></td></tr>
          </tbody>
        </table>
      </div>

      <div id="emptyState" style="display:none">
        <div class="empty-state">
          <div class="empty-icon">&#x2B21;</div>
          <div class="empty-msg">No deals found.<br>Adjust your filters or create a new deal to get started.</div>
        </div>
      </div>

      <div id="errorState" style="display:none">
        <div class="error-state">
          <div class="error-msg" id="errorMsg">Something went wrong loading deals.</div>
        </div>
      </div>

      <div class="pagination" id="pagination" style="display:none">
        <div class="pagination-info" id="paginationInfo">Page 1</div>
        <div class="pagination-btns">
          <button class="pagination-btn" id="prevBtn" disabled>Previous</button>
          <button class="pagination-btn" id="nextBtn">Next</button>
        </div>
      </div>
    </main>
  </div>

  <!-- New Deal Modal -->
  <div class="modal-overlay" id="newDealModal">
    <div class="modal">
      <div class="modal-title">New Deal</div>
      <div class="modal-desc">Create a new deal in the pipeline. You can add property and agent details later.</div>
      <div class="form-group">
        <label class="form-label" for="dealName">Deal Name</label>
        <input class="form-input" type="text" id="dealName" placeholder="e.g. 742 Evergreen Terrace Sale">
      </div>
      <div class="form-group">
        <label class="form-label" for="dealType">Type</label>
        <select class="form-select" id="dealType">
          <option value="purchase">Purchase</option>
          <option value="sale">Sale</option>
          <option value="lease">Lease</option>
          <option value="investment">Investment</option>
          <option value="development">Development</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="dealValue">Value</label>
        <input class="form-input" type="number" id="dealValue" placeholder="500000" step="1000" min="0">
      </div>
      <div class="form-group">
        <label class="form-label" for="dealClose">Expected Close</label>
        <input class="form-input" type="date" id="dealClose">
      </div>
      <div class="modal-actions">
        <button class="btn-primary" id="createDealBtn">Create Deal</button>
        <button class="btn-secondary" id="cancelDealBtn">Cancel</button>
      </div>
      <div class="modal-feedback" id="dealFeedback"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../../assets/js/admin-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../assets/includes/skr-shell.js"></script>
  <script src="../assets/js/skr-auth.js"></script>
  <script>
  var shell = SKR_SHELL.init({ activePage: 'deals' });

  SKR_AUTH.guard(function(member, sb) {
    shell.render(member);
    loadPageData(member, sb);
  });

  function loadPageData(member, sb) {
    var tableContainer = document.getElementById('tableContainer');
    var emptyState = document.getElementById('emptyState');
    var errorState = document.getElementById('errorState');
    var paginationEl = document.getElementById('pagination');

    var currentPage = 1;
    var pageSize = 20;
    var currentFilter = 'all';
    var searchQuery = '';

    function formatCurrency(val) {
      if (!val && val !== 0) return '—';
      return '$' + Number(val).toLocaleString('en-US', { minimumFractionDigits: 0 });
    }

    function formatDate(d) {
      if (!d) return '—';
      return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function stageBadge(stage) {
      var map = {
        new: 'badge-silver',
        active: 'badge-green',
        under_contract: 'badge-champagne',
        pending_close: 'badge-purple',
        closed_won: 'badge-gold',
        closed_lost: 'badge-red'
      };
      var cls = map[stage] || 'badge-silver';
      var label = (stage || 'unknown').replace(/_/g, ' ');
      return '<span class="badge ' + cls + '">' + label + '</span>';
    }

    function typeBadge(type) {
      var map = {
        purchase: 'badge-green',
        sale: 'badge-champagne',
        lease: 'badge-silver',
        investment: 'badge-gold',
        development: 'badge-purple'
      };
      var cls = map[type] || 'badge-silver';
      return '<span class="badge ' + cls + '">' + (type || 'unknown') + '</span>';
    }

    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    async function loadDeals() {
      tableContainer.style.display = 'block';
      emptyState.style.display = 'none';
      errorState.style.display = 'none';
      paginationEl.style.display = 'none';

      var tbody = document.getElementById('dealsBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--skr-text-muted)"><div class="spinner" style="margin:0 auto"></div></td></tr>';

      try {
        var url = '/api/deals/list?page=' + currentPage + '&limit=' + pageSize;
        if (currentFilter !== 'all') url += '&status=' + encodeURIComponent(currentFilter);
        if (searchQuery) url += '&search=' + encodeURIComponent(searchQuery);

        var data = await skrAPI(url);
        var deals = data.deals || data.data || [];
        var total = data.total || deals.length;

        updateStats(data.stats || null);

        if (deals.length === 0) {
          tableContainer.style.display = 'none';
          emptyState.style.display = 'block';
          return;
        }

        var html = '';
        deals.forEach(function(deal) {
          var agentNames = [];
          if (deal.listing_agent_name) agentNames.push(deal.listing_agent_name);
          if (deal.buying_agent_name) agentNames.push(deal.buying_agent_name);
          var agents = agentNames.length > 0 ? agentNames.join(', ') : '—';

          html += '<tr>'
            + '<td><a class="deal-link" href="detail.html?id=' + deal.id + '">' + escapeHtml(deal.deal_name || deal.name || 'Untitled') + '</a></td>'
            + '<td>' + typeBadge(deal.deal_type || deal.type) + '</td>'
            + '<td class="currency">' + formatCurrency(deal.deal_value || deal.value) + '</td>'
            + '<td>' + stageBadge(deal.status || deal.stage) + '</td>'
            + '<td class="agents-cell">' + escapeHtml(agents) + '</td>'
            + '<td class="date-cell">' + formatDate(deal.expected_close_date || deal.expected_close) + '</td>'
            + '</tr>';
        });
        tbody.innerHTML = html;

        var totalPages = Math.ceil(total / pageSize);
        if (totalPages > 1) {
          paginationEl.style.display = 'flex';
          document.getElementById('paginationInfo').textContent = 'Page ' + currentPage + ' of ' + totalPages + ' (' + total + ' deals)';
          document.getElementById('prevBtn').disabled = currentPage <= 1;
          document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }
      } catch (err) {
        console.warn('[SKR] Deals load error:', err);

        try {
          var q = sb.from('skr_deals').select('*', { count: 'exact' });
          if (currentFilter !== 'all') q = q.eq('status', currentFilter);
          if (searchQuery) q = q.ilike('deal_name', '%' + searchQuery + '%');
          q = q.order('created_at', { ascending: false })
            .range((currentPage - 1) * pageSize, currentPage * pageSize - 1);

          var result = await q;
          if (result.error) throw result.error;

          var deals = result.data || [];
          var total = result.count || deals.length;

          if (deals.length === 0) {
            tableContainer.style.display = 'none';
            emptyState.style.display = 'block';
            return;
          }

          var html = '';
          deals.forEach(function(deal) {
            html += '<tr>'
              + '<td><a class="deal-link" href="detail.html?id=' + deal.id + '">' + escapeHtml(deal.deal_name || 'Untitled') + '</a></td>'
              + '<td>' + typeBadge(deal.deal_type) + '</td>'
              + '<td class="currency">' + formatCurrency(deal.deal_value) + '</td>'
              + '<td>' + stageBadge(deal.status) + '</td>'
              + '<td class="agents-cell">&mdash;</td>'
              + '<td class="date-cell">' + formatDate(deal.expected_close_date) + '</td>'
              + '</tr>';
          });
          tbody.innerHTML = html;

          var totalPages = Math.ceil(total / pageSize);
          if (totalPages > 1) {
            paginationEl.style.display = 'flex';
            document.getElementById('paginationInfo').textContent = 'Page ' + currentPage + ' of ' + totalPages + ' (' + total + ' deals)';
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
          }

          loadStatsFromSupabase();
        } catch (sbErr) {
          console.warn('[SKR] Supabase fallback failed:', sbErr);
          tableContainer.style.display = 'none';
          emptyState.style.display = 'block';
        }
      }
    }

    function updateStats(stats) {
      if (!stats) return;
      if (stats.open != null) document.getElementById('statOpen').textContent = stats.open;
      if (stats.under_contract != null) document.getElementById('statContract').textContent = stats.under_contract;
      if (stats.pending_close != null) document.getElementById('statPending').textContent = stats.pending_close;
      if (stats.closed_ytd != null) document.getElementById('statClosed').textContent = stats.closed_ytd;
    }

    async function loadStatsFromSupabase() {
      try {
        var openR = await sb.from('skr_deals').select('*', { count: 'exact', head: true }).in('status', ['new', 'active']);
        document.getElementById('statOpen').textContent = openR.count || 0;

        var contractR = await sb.from('skr_deals').select('*', { count: 'exact', head: true }).eq('status', 'under_contract');
        document.getElementById('statContract').textContent = contractR.count || 0;

        var pendingR = await sb.from('skr_deals').select('*', { count: 'exact', head: true }).eq('status', 'pending_close');
        document.getElementById('statPending').textContent = pendingR.count || 0;

        var ytdStart = new Date(new Date().getFullYear(), 0, 1).toISOString();
        var closedR = await sb.from('skr_deals').select('*', { count: 'exact', head: true }).eq('status', 'closed_won').gte('updated_at', ytdStart);
        document.getElementById('statClosed').textContent = closedR.count || 0;
      } catch (e) { console.warn('[SKR] Stats:', e); }
    }

    document.getElementById('filterTabs').addEventListener('click', function(e) {
      var tab = e.target.closest('.filter-tab');
      if (!tab) return;
      document.querySelectorAll('.filter-tab').forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      currentFilter = tab.dataset.filter;
      currentPage = 1;
      loadDeals();
    });

    var searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      var val = this.value.trim();
      searchTimeout = setTimeout(function() {
        searchQuery = val;
        currentPage = 1;
        loadDeals();
      }, 350);
    });

    document.getElementById('prevBtn').addEventListener('click', function() {
      if (currentPage > 1) { currentPage--; loadDeals(); }
    });
    document.getElementById('nextBtn').addEventListener('click', function() {
      currentPage++;
      loadDeals();
    });

    var modal = document.getElementById('newDealModal');
    document.getElementById('newDealBtn').addEventListener('click', function() { modal.classList.add('active'); });
    document.getElementById('cancelDealBtn').addEventListener('click', function() { closeNewDealModal(); });
    modal.addEventListener('click', function(e) { if (e.target === modal) closeNewDealModal(); });

    function closeNewDealModal() {
      modal.classList.remove('active');
      document.getElementById('dealName').value = '';
      document.getElementById('dealValue').value = '';
      document.getElementById('dealClose').value = '';
      document.getElementById('dealFeedback').textContent = '';
      document.getElementById('dealFeedback').className = 'modal-feedback';
    }

    document.getElementById('createDealBtn').addEventListener('click', async function() {
      var btn = this;
      var name = document.getElementById('dealName').value.trim();
      var type = document.getElementById('dealType').value;
      var value = document.getElementById('dealValue').value;
      var close = document.getElementById('dealClose').value;
      var fb = document.getElementById('dealFeedback');

      if (!name) { fb.textContent = 'Deal name is required.'; fb.className = 'modal-feedback error'; return; }

      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        await skrAPI('/api/deals/create', {
          method: 'POST',
          body: {
            deal_name: name,
            deal_type: type,
            deal_value: value ? Number(value) : null,
            expected_close_date: close || null
          }
        });

        fb.textContent = 'Deal created successfully.';
        fb.className = 'modal-feedback success';
        setTimeout(function() { closeNewDealModal(); loadDeals(); }, 800);
      } catch (err) {
        try {
          var insertResult = await sb.from('skr_deals').insert({
            deal_name: name,
            deal_type: type,
            deal_value: value ? Number(value) : null,
            expected_close_date: close || null,
            status: 'new',
            created_by: member.id
          }).select().single();

          if (insertResult.error) throw insertResult.error;

          fb.textContent = 'Deal created successfully.';
          fb.className = 'modal-feedback success';
          setTimeout(function() { closeNewDealModal(); loadDeals(); }, 800);
        } catch (sbErr) {
          fb.textContent = sbErr.message || 'Failed to create deal.';
          fb.className = 'modal-feedback error';
        }
      }

      btn.disabled = false;
      btn.textContent = 'Create Deal';
    });

    loadDeals();
  }
  </script>
</body>
</html>
